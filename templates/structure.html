<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GEX Structure</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #06080c;
  --bg2: #0b0e14;
  --bg3: #10141c;
  --border: #1c2230;
  --border2: #262e3e;
  --t1: #dce0e8;
  --t2: #8892a4;
  --t3: #4a5568;
  --green: #00dc82;
  --red: #ff4060;
  --amber: #ffb020;
  --blue: #3890ff;
  --purple: #a78bfa;
  --mono: 'IBM Plex Mono', 'Consolas', monospace;
  --sans: 'Outfit', system-ui, sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:var(--mono);background:var(--bg);color:var(--t1);font-size:11px;line-height:1.4;display:flex;flex-direction:column}
.hdr{height:36px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 12px;gap:16px;flex-shrink:0}
.hdr-logo{font-family:var(--sans);font-weight:800;font-size:13px;letter-spacing:-.3px;color:var(--t2)}
.hdr-sep{width:1px;height:18px;background:var(--border2)}
.range-btn{background:var(--bg3);color:var(--t3);border:1px solid var(--border2);border-radius:2px;padding:2px 8px;font-family:var(--mono);font-size:10px;cursor:pointer}
.range-btn.active{color:var(--t1);border-color:var(--t2)}
.hdr-select{background:var(--bg3);color:var(--t1);border:1px solid var(--border2);border-radius:2px;padding:2px 4px;font-family:var(--mono);font-size:10px;cursor:pointer}
.chart-wrap{flex:1;min-height:0;padding:12px;position:relative}
canvas{width:100%!important;height:100%!important}
.legend{display:flex;gap:16px;padding:8px 12px;background:var(--bg2);border-top:1px solid var(--border);flex-shrink:0;align-items:center;justify-content:center;flex-wrap:wrap}
.leg-item{display:flex;align-items:center;gap:5px;font-size:10px;color:#8892a4}
.leg-swatch{width:20px;height:10px;border-radius:1px}
.empty-msg{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--t3);font-size:12px;text-align:center;padding:40px}
</style>
</head>
<body>
<div class="hdr">
  <a href="/" style="color:var(--t3);font-size:10px;text-decoration:none">&larr; Dashboard</a>
  <div class="hdr-sep"></div>
  <span class="hdr-logo">GEX Structure</span>
  <div style="flex:1"></div>
  <select id="heatmap-select" onchange="load(currentDays)" class="hdr-select">
    <option value="off">Heatmap Off</option>
    <option value="oi">Total OI</option>
    <option value="gex">Net GEX</option>
  </select>
  <div class="hdr-sep"></div>
  <button class="range-btn" onclick="load(7)" id="btn-7">7d</button>
  <button class="range-btn active" onclick="load(30)" id="btn-30">30d</button>
  <button class="range-btn" onclick="load(90)" id="btn-90">90d</button>
  <div class="hdr-sep"></div>
  <button class="range-btn" onclick="toggleFocus()" id="btn-focus">Focus</button>
</div>
<div class="chart-wrap">
  <canvas id="chart"></canvas>
  <div class="empty-msg" id="empty" style="display:none">Collecting data &mdash; structure chart populates after the first few days of predictions.</div>
</div>
<div class="legend">
  <div class="leg-item"><div class="leg-swatch" style="background:rgba(0,220,130,0.12);border:1.5px solid rgba(0,220,130,0.55)"></div><span>0-3d</span></div>
  <div class="leg-item"><div class="leg-swatch" style="background:rgba(0,180,220,0.10);border:1.5px solid rgba(0,180,220,0.45)"></div><span>4-7d</span></div>
  <div class="leg-item"><div class="leg-swatch" style="background:rgba(56,144,255,0.08);border:1.5px solid rgba(56,144,255,0.35)"></div><span>8-14d</span></div>
  <div class="leg-item"><div class="leg-swatch" style="background:rgba(255,176,32,0.06);border:1.5px solid rgba(255,176,32,0.25)"></div><span>15-30d</span></div>
  <div class="leg-item"><div class="leg-swatch" style="background:rgba(168,139,250,0.06);border:1.5px solid rgba(168,139,250,0.25)"></div><span>31-45d</span></div>
  <div class="leg-item"><div class="leg-swatch" style="background:var(--t1);height:2px;border:none"></div><span>Spot</span></div>
  <div class="leg-item"><div class="leg-swatch" style="background:none;height:0;border-top:1.5px dashed rgba(255,176,32,0.6);border-left:none;border-right:none;border-bottom:none"></div><span>&gamma; Flip</span></div>
  <div class="leg-item"><span style="color:rgba(0,220,130,0.9);font-size:12px">&#9670;</span><span>Venue agree</span></div>
  <div class="leg-item leg-heat leg-heat-oi" style="display:none"><div class="leg-swatch" style="background:linear-gradient(to right, rgba(56,144,255,0.05), rgba(56,144,255,0.40));border:none"></div><span>OI density (low &rarr; high)</span></div>
  <div class="leg-item leg-heat leg-heat-gex" style="display:none"><div class="leg-swatch" style="background:linear-gradient(to right, rgba(255,64,96,0.35), rgba(56,56,56,0.1), rgba(0,220,130,0.35));border:none"></div><span>GEX (put-heavy &rarr; call-heavy)</span></div>
</div>
<script>
let chart = null;
let currentDays = 30;
let focusMode = false;
let latestSpot = null;

const WINDOWS = [
  {key:'31-45', label:'31-45d', bg:'rgba(168,139,250,0.06)', border:'rgba(168,139,250,0.25)', bw: 1},
  {key:'15-30', label:'15-30d', bg:'rgba(255,176,32,0.06)',  border:'rgba(255,176,32,0.25)',  bw: 1},
  {key:'8-14',  label:'8-14d',  bg:'rgba(56,144,255,0.08)',  border:'rgba(56,144,255,0.35)',  bw: 1.5},
  {key:'4-7',   label:'4-7d',   bg:'rgba(0,180,220,0.10)',   border:'rgba(0,180,220,0.45)',   bw: 1.5},
  {key:'0-3',   label:'0-3d',   bg:'rgba(0,220,130,0.12)',   border:'rgba(0,220,130,0.55)',   bw: 2},
];

const heatmapPlugin = {
  id: 'heatmapBg',
  beforeDatasetsDraw(chart) {
    if (!window._heatData || !window._heatMode || window._heatMode === 'off') return;

    const ctx = chart.ctx;
    const xScale = chart.scales.x;
    const yScale = chart.scales.y;
    const meta = window._heatData;
    const mode = window._heatMode;
    const dates = window._structDates;
    const bucketSize = meta.bucket_size || 1000;

    let maxVal = 0;
    for (const date of dates) {
      const cells = meta.data[date] || [];
      for (const cell of cells) {
        const val = mode === 'oi' ? cell.total_oi : Math.abs(cell.net_gex);
        if (val > maxVal) maxVal = val;
      }
    }
    if (maxVal === 0) return;

    const cellW = dates.length > 1
      ? Math.abs(xScale.getPixelForValue(1) - xScale.getPixelForValue(0))
      : 40;

    for (let i = 0; i < dates.length; i++) {
      const cells = meta.data[dates[i]] || [];
      const cx = xScale.getPixelForValue(i);

      for (const cell of cells) {
        const cy = yScale.getPixelForValue(cell.price);
        const halfBucket = yScale.getPixelForValue(cell.price - bucketSize / 2)
                         - yScale.getPixelForValue(cell.price + bucketSize / 2);
        const cellH = Math.max(Math.abs(halfBucket), 2);

        if (mode === 'oi') {
          const intensity = Math.min(cell.total_oi / maxVal, 1);
          const alpha = 0.05 + intensity * 0.35;
          ctx.fillStyle = `rgba(56,144,255,${alpha})`;
        } else {
          const intensity = Math.min(Math.abs(cell.net_gex) / maxVal, 1);
          const alpha = 0.05 + intensity * 0.35;
          if (cell.net_gex >= 0) {
            ctx.fillStyle = `rgba(0,220,130,${alpha})`;
          } else {
            ctx.fillStyle = `rgba(255,64,96,${alpha})`;
          }
        }

        ctx.fillRect(cx - cellW / 2, cy - cellH / 2, cellW, cellH);
      }
    }
  },
};

function toggleFocus() {
  focusMode = !focusMode;
  document.getElementById('btn-focus').classList.toggle('active', focusMode);
  load(currentDays);
}

async function load(days) {
  currentDays = days;
  document.querySelectorAll('.range-btn:not(#btn-focus)').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-' + days).classList.add('active');

  const heatmapMode = document.getElementById('heatmap-select').value;

  try {
    const [structRes, heatRes] = await Promise.all([
      fetch('/api/structure?ticker=IBIT&days=' + days).then(r => r.json()),
      heatmapMode !== 'off'
        ? fetch('/api/structure/heatmap?ticker=IBIT&days=' + days).then(r => r.json())
        : Promise.resolve(null),
    ]);
    render(structRes, heatRes, heatmapMode);
  } catch(e) {
    console.error('Structure fetch failed:', e);
  }
}

function render(data, heatData, heatMode) {
  window._heatData = heatData;
  window._heatMode = heatMode || 'off';

  // Toggle heatmap legend items
  document.querySelectorAll('.leg-heat').forEach(el => el.style.display = 'none');
  if (heatMode === 'oi') {
    document.querySelector('.leg-heat-oi').style.display = 'flex';
  } else if (heatMode === 'gex') {
    document.querySelector('.leg-heat-gex').style.display = 'flex';
  }

  const dates = Object.keys(data).sort();
  const emptyEl = document.getElementById('empty');
  const canvas = document.getElementById('chart');

  if (dates.length === 0) {
    emptyEl.style.display = 'flex';
    canvas.style.display = 'none';
    if (chart) { chart.destroy(); chart = null; }
    return;
  }
  emptyEl.style.display = 'none';
  canvas.style.display = 'block';

  // Extract latest spot for focus mode
  latestSpot = data[dates[dates.length - 1]]?.spot || null;

  // Detect expiry rollovers (>5% jump in 0-3d call wall)
  const expirySet = new Set();
  for (let i = 1; i < dates.length; i++) {
    const prev = data[dates[i-1]]?.windows?.['0-3'];
    const curr = data[dates[i]]?.windows?.['0-3'];
    if (prev && curr && prev.call_wall && curr.call_wall) {
      const jump = Math.abs(curr.call_wall - prev.call_wall) / prev.call_wall;
      if (jump > 0.05) expirySet.add(dates[i]);
    }
  }

  const datasets = [];

  // Bands: widest first (31-45d) to narrowest (0-3d)
  for (const w of WINDOWS) {
    datasets.push({
      label: w.label + ' CW',
      data: dates.map(d => data[d]?.windows?.[w.key]?.call_wall || null),
      borderColor: w.border,
      borderWidth: w.bw,
      pointRadius: 0,
      fill: false,
      spanGaps: true,
      tension: 0,
    });
    datasets.push({
      label: w.label + ' PW',
      data: dates.map(d => data[d]?.windows?.[w.key]?.put_wall || null),
      borderColor: w.border,
      borderWidth: w.bw,
      pointRadius: 0,
      fill: '-1',
      backgroundColor: w.bg,
      spanGaps: true,
      tension: 0,
    });
  }

  // Gamma flip (0-3d) — dashed amber
  datasets.push({
    label: 'Gamma Flip',
    data: dates.map(d => data[d]?.windows?.['0-3']?.gamma_flip || null),
    borderColor: 'rgba(255,176,32,0.6)',
    borderWidth: 1.5,
    borderDash: [4, 3],
    pointRadius: 0,
    fill: false,
    spanGaps: true,
    tension: 0,
  });

  // Spot — solid white
  datasets.push({
    label: 'Spot',
    data: dates.map(d => data[d]?.spot || null),
    borderColor: 'rgba(220,224,232,0.9)',
    borderWidth: 2.5,
    pointRadius: 2,
    pointBackgroundColor: 'rgba(220,224,232,0.9)',
    fill: false,
    spanGaps: true,
    tension: 0,
  });

  // Venue agreement markers on 0-3d walls
  const hasAgree = dates.some(d => data[d]?.windows?.['0-3']?.venue_agree);
  if (hasAgree) {
    datasets.push({
      label: 'Venue agree (CW)',
      data: dates.map(d => {
        const w = data[d]?.windows?.['0-3'];
        return (w && w.venue_agree) ? w.call_wall : null;
      }),
      borderColor: 'transparent',
      backgroundColor: 'rgba(0,220,130,0.9)',
      pointRadius: 4,
      pointStyle: 'rectRot',
      pointBorderColor: 'rgba(0,220,130,1)',
      pointBorderWidth: 1,
      showLine: false,
      fill: false,
      spanGaps: false,
    });
    datasets.push({
      label: 'Venue agree (PW)',
      data: dates.map(d => {
        const w = data[d]?.windows?.['0-3'];
        return (w && w.venue_agree) ? w.put_wall : null;
      }),
      borderColor: 'transparent',
      backgroundColor: 'rgba(0,220,130,0.9)',
      pointRadius: 4,
      pointStyle: 'rectRot',
      pointBorderColor: 'rgba(0,220,130,1)',
      pointBorderWidth: 1,
      showLine: false,
      fill: false,
      spanGaps: false,
    });
  }

  // Store data ref for tooltip
  window._structData = data;
  window._structDates = dates;

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById('chart'), {
    type: 'line',
    data: { labels: dates, datasets },
    plugins: [heatmapPlugin],
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(11,14,20,0.95)',
          borderColor: 'rgba(28,34,48,1)',
          borderWidth: 1,
          titleFont: { family: "'IBM Plex Mono', monospace", size: 11 },
          bodyFont: { family: "'IBM Plex Mono', monospace", size: 10 },
          padding: 10,
          filter: () => false,
          callbacks: {
            title: function(items) {
              return items[0]?.label || '';
            },
            afterBody: function(items) {
              const date = items[0]?.label;
              if (!date || !window._structData[date]) return '';
              const d = window._structData[date];
              const lines = [];
              const fB = v => '$' + Math.round(v).toLocaleString();
              lines.push('Spot: ' + fB(d.spot));
              const order = ['0-3','4-7','8-14','15-30','31-45'];
              for (const k of order) {
                const w = d.windows?.[k];
                if (!w) continue;
                let line = k.padEnd(6) + fB(w.put_wall) + ' \u2014 ' + fB(w.call_wall);
                const regime = w.regime === 'negative_gamma' ? ' (neg \u03B3)' : ' (pos \u03B3)';
                line += regime;
                if (w.venue_agree) line += ' \u2713';
                lines.push(line);
              }
              const gf = d.windows?.['0-3']?.gamma_flip;
              if (gf) lines.push('\u03B3 flip: ' + fB(gf));
              // Heatmap data at spot
              if (window._heatData && window._heatMode !== 'off' && window._heatData.data[date]) {
                const cells = window._heatData.data[date];
                if (cells.length > 0) {
                  const spotBucket = cells.reduce((best, c) =>
                    Math.abs(c.price - d.spot) < Math.abs(best.price - d.spot) ? c : best,
                    cells[0]
                  );
                  if (spotBucket) {
                    lines.push('');
                    lines.push('At spot (' + fB(spotBucket.price) + '):');
                    lines.push('  OI: ' + spotBucket.total_oi.toLocaleString() + ' (' + spotBucket.call_oi.toLocaleString() + 'C / ' + spotBucket.put_oi.toLocaleString() + 'P)');
                    lines.push('  GEX: ' + (spotBucket.net_gex / 1e6).toFixed(1) + 'M');
                  }
                }
              }
              return lines.join('\n');
            },
            label: () => null,
          },
        },
      },
      scales: {
        x: {
          grid: { color: 'rgba(28,34,48,0.5)' },
          ticks: {
            color: function(ctx) {
              const date = window._structDates?.[ctx.index];
              return expirySet.has(date) ? '#ffb020' : '#4a5568';
            },
            font: { size: 10, family: "'IBM Plex Mono'" },
            maxRotation: 0,
            autoSkip: true,
            maxTicksLimit: 15,
            callback: function(val, idx) {
              const d = this.getLabelForValue(val);
              return d ? d.slice(5) : '';
            },
          },
        },
        y: {
          grace: focusMode ? '0%' : '5%',
          min: focusMode && latestSpot ? latestSpot * 0.85 : undefined,
          max: focusMode && latestSpot ? latestSpot * 1.15 : undefined,
          grid: { color: 'rgba(28,34,48,0.5)' },
          ticks: {
            color: '#4a5568',
            font: { size: 10, family: "'IBM Plex Mono'" },
            callback: v => '$' + (v/1000).toFixed(0) + 'K',
          },
        },
      },
    },
  });
}

load(30);
</script>
</body>
</html>
