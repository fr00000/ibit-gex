<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GEX Terminal</title>
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #06080c;
  --bg2: #0b0e14;
  --bg3: #10141c;
  --bg4: #161b26;
  --border: #1c2230;
  --border2: #262e3e;
  --t1: #dce0e8;
  --t2: #8892a4;
  --t3: #4a5568;
  --green: #00dc82;
  --green2: #00b86b;
  --green-bg: rgba(0,220,130,0.07);
  --green-bd: rgba(0,220,130,0.20);
  --red: #ff4060;
  --red2: #d63050;
  --red-bg: rgba(255,64,96,0.07);
  --red-bd: rgba(255,64,96,0.20);
  --amber: #ffb020;
  --amber-bg: rgba(255,176,32,0.07);
  --blue: #3890ff;
  --blue-bg: rgba(56,144,255,0.06);
  --purple: #a78bfa;
  --mono: 'IBM Plex Mono', 'Consolas', monospace;
  --sans: 'Outfit', system-ui, sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:var(--mono);background:var(--bg);color:var(--t1);font-size:11px;line-height:1.4}

/* LOADING */
#loading{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;z-index:9999;transition:opacity .3s,visibility .3s}
#loading.hidden{opacity:0;visibility:hidden;pointer-events:none}
#loading .spin{width:24px;height:24px;border:2px solid var(--border2);border-top-color:var(--blue);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
#loading .lt{color:var(--t3);font-size:11px;letter-spacing:.5px}

/* HEADER */
.hdr{height:36px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 12px;gap:16px;flex-shrink:0}
.hdr-logo{font-family:var(--sans);font-weight:800;font-size:13px;letter-spacing:-.3px;color:var(--t2);margin-right:4px}
.hdr-logo b{color:var(--blue)}
.hdr-sep{width:1px;height:18px;background:var(--border2)}
.hdr-price{font-size:15px;font-weight:700;letter-spacing:-.5px;font-family:var(--sans)}
.hdr-sub{font-size:10px;color:var(--t3);margin-left:4px}
.hdr-regime{font-size:9px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;padding:2px 8px;border-radius:2px}
.regime-neg{background:var(--red-bg);color:var(--red);border:1px solid var(--red-bd)}
.regime-pos{background:var(--green-bg);color:var(--green);border:1px solid var(--green-bd)}
/* CONFIDENCE BADGE */
.hdr-conf{font-size:9px;font-weight:600;letter-spacing:.6px;padding:2px 7px;border-radius:2px;cursor:default;position:relative}
.hdr-conf:hover .conf-tip{display:block}
.conf-hi{background:var(--green-bg);color:var(--green);border:1px solid var(--green-bd)}
.conf-mid{background:var(--amber-bg);color:var(--amber);border:1px solid rgba(255,176,32,.2)}
.conf-lo{background:var(--red-bg);color:var(--red);border:1px solid var(--red-bd)}
.conf-tip{display:none;position:absolute;top:100%;right:0;margin-top:6px;background:var(--bg4);border:1px solid var(--border2);border-radius:3px;padding:6px 9px;font-size:9px;color:var(--t2);line-height:1.5;width:280px;white-space:normal;z-index:30;box-shadow:0 4px 12px rgba(0,0,0,.5);font-weight:400;letter-spacing:0}
.conf-tip strong{color:var(--t1);display:block;margin-bottom:3px}
.conf-tip .cw{margin-top:3px;padding-top:3px;border-top:1px solid var(--border)}
.hdr-flow{font-size:9px;font-weight:600;letter-spacing:.6px;padding:2px 7px;border-radius:2px}
.flow-in{background:var(--green-bg);color:var(--green);border:1px solid var(--green-bd)}
.flow-out{background:var(--red-bg);color:var(--red);border:1px solid var(--red-bd)}
.flow-flat{background:var(--bg3);color:var(--t3);border:1px solid var(--border)}

.hdr-tabs{display:flex;gap:2px;background:var(--bg3);border-radius:3px;padding:2px}
.hdr-tab{font-family:var(--mono);font-size:10px;font-weight:600;letter-spacing:.5px;padding:2px 10px;border-radius:2px;border:none;background:none;color:var(--t3);cursor:pointer;transition:all .15s}
.hdr-tab:hover{color:var(--t2)}
.hdr-tab.active{background:var(--blue);color:var(--bg)}
.hdr-right{margin-left:auto;display:flex;align-items:center;gap:10px}
.hdr-ts{color:var(--t3);font-size:10px}
.hdr-btn{background:none;border:1px solid var(--border2);color:var(--t3);padding:3px 10px;border-radius:2px;cursor:pointer;font-family:var(--mono);font-size:10px;transition:all .15s}
.hdr-btn:hover{border-color:var(--blue);color:var(--blue)}

/* GRID */
.grid{display:grid;grid-template-columns:1fr 1fr 300px 340px;grid-template-rows:1fr 1fr 1fr;height:calc(100vh - 36px);gap:1px;background:var(--border)}

/* CHART AREA */
.chart-area{background:var(--bg);grid-row:1;grid-column:1;position:relative;min-height:0;min-width:0}
#tv-chart{width:100%;height:100%}
.chart-legend{position:absolute;top:8px;left:8px;z-index:10;background:rgba(6,8,12,.85);border:1px solid var(--border);border-radius:3px;padding:5px 8px;display:flex;flex-wrap:wrap;gap:2px 10px}
.chart-legend-item{display:flex;align-items:center;gap:4px;font-size:8px;color:var(--t2);cursor:default;position:relative}
.chart-legend-item:hover{color:var(--t1)}
.chart-legend-item:hover .chart-legend-tip{display:block}
.chart-legend-line{width:14px;height:0;border-top:2px solid}
.chart-legend-line.dashed{border-top-style:dashed}
.chart-legend-tip{display:none;position:absolute;top:100%;left:0;margin-top:4px;background:var(--bg4);border:1px solid var(--border2);border-radius:3px;padding:5px 8px;font-size:9px;color:var(--t2);line-height:1.4;width:220px;white-space:normal;z-index:20;box-shadow:0 4px 12px rgba(0,0,0,.4)}

/* BOTTOM CHARTS */
.outlook-row{grid-row:1;grid-column:2;background:var(--bg);padding:6px 10px;display:flex;flex-direction:column;min-height:0;min-width:0}
.outlook-row .cell-label{font-size:9px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:2px;display:flex;align-items:center;gap:5px}
.outlook-row .cell-label::before{content:'';display:inline-block;width:6px;height:6px;border-radius:1px;background:var(--blue)}
.outlook-row canvas{flex:1;min-height:0}
.outlook-legend{display:flex;gap:14px;padding:4px 0 0;justify-content:center;flex-wrap:wrap}
.outlook-legend span{font-size:9px;color:var(--t3)}
.cell-label{font-size:9px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:4px;display:flex;align-items:center;gap:5px}
.cell-label::before{content:'';display:inline-block;width:6px;height:6px;border-radius:1px}
.cell-gex{grid-row:2;grid-column:1;background:var(--bg);padding:6px 10px;display:flex;flex-direction:column;min-height:0;min-width:0}
.cell-gex .cell-label::before{background:var(--amber)}
.cell-delta{grid-row:2;grid-column:2;background:var(--bg);padding:6px 10px;display:flex;flex-direction:column;min-height:0;min-width:0}
.cell-delta .cell-label::before{background:var(--purple)}
.cell-structure{grid-row:3;grid-column:1;background:var(--bg);padding:6px 10px;display:flex;flex-direction:column;min-height:0;min-width:0}
.cell-structure .cell-label::before{background:var(--blue)}
.cell-flow{grid-row:3;grid-column:2;background:var(--bg);padding:6px 10px;display:flex;flex-direction:column;min-height:0;min-width:0}
.cell-flow .cell-label::before{background:var(--green)}
.cell canvas{flex:1;min-height:0}
.cell-tab{cursor:pointer;opacity:0.4;transition:opacity .15s}
.cell-tab.active{opacity:1}
.cell-tab:hover{opacity:0.7}

/* RIGHT PANEL */
.right{grid-row:1/4;grid-column:3;background:var(--bg2);overflow-y:auto;overflow-x:hidden;scrollbar-width:thin;scrollbar-color:var(--border2) transparent}
.right::-webkit-scrollbar{width:4px}
.right::-webkit-scrollbar-track{background:transparent}
.right::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* AI PANEL */
.ai-panel{grid-row:1/4;grid-column:4;background:var(--bg2);overflow-y:auto;overflow-x:hidden;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;padding:8px 12px}
.ai-panel::-webkit-scrollbar{width:4px}
.ai-panel::-webkit-scrollbar-track{background:transparent}
.ai-panel::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* RIGHT PANEL SECTIONS */
.sec{padding:8px 12px;border-bottom:1px solid var(--border)}
.sec:last-child{border-bottom:none}
.sec-title{font-size:9px;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--t3);margin-bottom:6px;display:flex;align-items:center;gap:5px}
.sec-title .dot{width:5px;height:5px;border-radius:1px;display:inline-block}

/* REGIME BANNER */
.regime-banner{padding:7px 10px;border-radius:3px;font-size:10px;line-height:1.5}
.regime-banner strong{display:block;font-size:10px;letter-spacing:.4px;margin-bottom:1px}
.rbn{background:var(--red-bg);border:1px solid var(--red-bd);color:var(--red)}
.rbp{background:var(--green-bg);border:1px solid var(--green-bd);color:var(--green)}

/* EXPECTED MOVE */
.em-bar{display:flex;justify-content:space-between;align-items:center;background:var(--blue-bg);border:1px solid rgba(56,144,255,.12);border-radius:3px;padding:6px 10px;margin-top:6px}
.em-bar .em-l{font-size:10px;color:var(--t2)}
.em-bar .em-v{font-size:12px;font-weight:600;font-family:var(--sans)}

/* KEY LEVELS */
.kl-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:11px}
.kl-row+.kl-row{border-top:1px solid rgba(28,34,48,.6)}
.kl-name{font-size:10px}
.kl-vals{display:flex;align-items:center;gap:6px}
.kl-btc{font-weight:600}
.kl-ibit{color:var(--t3);font-size:9px}
.kl-dist{font-size:9px;font-weight:500;padding:1px 4px;border-radius:2px}
.d-up{background:var(--green-bg);color:var(--green)}
.d-dn{background:var(--red-bg);color:var(--red)}

/* RANGE VISUAL */
.range-box{background:var(--bg3);border:1px solid var(--border);border-radius:3px;padding:6px 10px;margin-top:4px}
.range-track{position:relative;height:16px;background:linear-gradient(90deg,var(--red-bg),var(--bg3) 35%,var(--bg3) 65%,var(--green-bg));border-radius:2px;margin:6px 0 4px;border:1px solid var(--border)}
.range-needle{position:absolute;top:-2px;bottom:-2px;width:2px;background:var(--blue);border-radius:1px}
.range-ends{display:flex;justify-content:space-between;font-size:9px;color:var(--t3)}

/* SIG LEVELS */
.sl-row{padding:4px 0;border-bottom:1px solid rgba(28,34,48,.5)}
.sl-row:last-child{border:none}
.sl-top{display:flex;justify-content:space-between;align-items:center;font-size:10px}
.sl-price{font-weight:600}
.sl-oi{color:var(--t3);font-size:9px}
.sl-beh{font-size:9px;color:var(--t3);margin-top:1px}
.sl-delta{font-size:8px;font-weight:600;padding:1px 4px;border-radius:2px;margin-left:4px}
.sld-b{background:var(--green-bg);color:var(--green)}
.sld-d{background:var(--red-bg);color:var(--red)}
.sld-s{background:var(--blue-bg);color:var(--blue)}

/* BREAKOUT */
.bo-dir{padding:6px 8px;border-radius:3px;margin-bottom:5px}
.bo-up{background:var(--green-bg);border:1px solid var(--green-bd)}
.bo-dn{background:var(--red-bg);border:1px solid var(--red-bd)}
.bo-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.bo-label{font-weight:600;font-size:10px}
.bo-dots{display:flex;gap:2px}
.bo-dot{width:6px;height:6px;border-radius:1px}
.bo-dot-g{background:var(--green)}
.bo-dot-r{background:var(--red)}
.bo-dot-e{background:var(--border2)}
.bo-sig{font-size:9px;color:var(--t2);padding:1px 0}
.bo-tgt{font-size:9px;color:var(--t3);margin-top:3px;padding-top:3px;border-top:1px solid var(--border)}
.bias-box{text-align:center;padding:4px 8px;border-radius:2px;font-weight:600;font-size:9px;background:var(--bg3);border:1px solid var(--border);margin-top:4px;letter-spacing:.3px}

/* DEALER STATS */
.ds-row{display:flex;justify-content:space-between;padding:2px 0;font-size:10px}
.ds-row .dl{color:var(--t3)}
.ds-row .dv{font-weight:500}

/* FLOW FORECAST */
.ff-box{background:var(--bg3);border:1px solid var(--border);border-radius:3px;padding:6px 8px;margin-bottom:5px}
.ff-hdr{font-weight:600;font-size:9px;letter-spacing:.4px;margin-bottom:4px;display:flex;align-items:center;gap:5px}
.ff-row{display:flex;justify-content:space-between;padding:2px 0;font-size:10px}
.ff-row .ffl{color:var(--t3);font-size:9px}
.ff-row .ffv{font-weight:500;font-size:10px}
.ff-dir{font-size:9px;font-weight:600;padding:1px 6px;border-radius:2px;display:inline-block;margin-top:2px}
.ff-buy{background:var(--green-bg);color:var(--green);border:1px solid var(--green-bd)}
.ff-sell{background:var(--red-bg);color:var(--red);border:1px solid var(--red-bd)}
.ff-negl{color:var(--t3);font-size:9px;font-style:italic}
.ff-note{font-size:9px;color:var(--t3);margin-top:3px;padding-top:3px;border-top:1px solid var(--border);line-height:1.4}
.ff-scenario{display:flex;justify-content:space-between;align-items:center;padding:2px 0;font-size:9px}
.ff-scenario .ffs-l{color:var(--t3)}
.ff-scenario .ffs-v{font-weight:500}
.sl-greeks{font-size:8px;color:var(--purple);margin-top:1px;opacity:.8}

/* OI CHANGES */
.oi-box{background:var(--bg3);border:1px solid var(--border);border-radius:3px;padding:5px 8px;font-size:10px}
.oi-box .oi-hdr{font-weight:600;color:var(--t3);font-size:9px;margin-bottom:3px}
.oi-r{display:flex;justify-content:space-between;padding:1px 0}
.oi-interp{color:var(--amber);font-weight:500;margin-top:2px;font-size:9px}

/* HISTORY */
.hist-row{display:grid;grid-template-columns:48px 72px 24px 1fr;gap:3px;padding:2px 0;font-size:9px;align-items:center;border-bottom:1px solid rgba(28,34,48,.4)}
.hist-row:last-child{border:none}
.hist-date{color:var(--t3)}
.hist-gex{text-align:right;color:var(--t3)}

/* AI ANALYSIS */
.ai-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.ai-hdr .sec-title{margin-bottom:0}
.ai-btn{background:none;border:1px solid var(--blue);color:var(--blue);padding:2px 10px;border-radius:2px;cursor:pointer;font-family:var(--mono);font-size:9px;font-weight:600;letter-spacing:.6px;transition:all .15s}
.ai-btn:hover{background:var(--blue);color:var(--bg)}
.ai-btn:disabled{opacity:.4;cursor:not-allowed}
.ai-btn-save{border-color:#00dc82;color:#00dc82}
.ai-btn-save:hover{background:#00dc82;color:var(--bg)}
.ai-unsaved{font-size:8px;color:#f0a040;margin-left:6px;letter-spacing:.3px}
.ai-content{background:var(--bg3);border:1px solid var(--border);border-radius:3px;padding:8px 10px;font-size:10px;line-height:1.6;color:var(--t2);min-height:60px;white-space:pre-wrap;word-wrap:break-word}
.ai-content .ai-loading{display:flex;align-items:center;gap:8px;color:var(--t3);font-size:10px}
.ai-content .ai-loading .spin{width:14px;height:14px;border:2px solid var(--border2);border-top-color:var(--blue);border-radius:50%;animation:sp .7s linear infinite;flex-shrink:0}
.ai-content strong{color:var(--t1);font-weight:600}
.ai-empty{color:var(--t3);font-size:10px;font-style:italic}

/* RESPONSIVE */
@media(max-width:1400px){
  .grid{grid-template-columns:1fr 1fr 300px;grid-template-rows:1fr 1fr 1fr auto}
  .right{grid-column:3}
  .ai-panel{grid-row:4;grid-column:1/4;max-height:40vh}
}
@media(max-width:1100px){
  .grid{grid-template-columns:1fr 1fr;grid-template-rows:33vh 33vh 33vh 33vh auto auto}
  .chart-area{grid-row:1;grid-column:1/3}
  .outlook-row{grid-row:2;grid-column:1/3}
  .cell-gex{grid-row:3;grid-column:1}
  .cell-delta{grid-row:3;grid-column:2}
  .cell-structure{grid-row:4;grid-column:1}
  .cell-flow{grid-row:4;grid-column:2}
  .right{grid-row:5;grid-column:1/3;max-height:50vh}
  .ai-panel{grid-row:6;grid-column:1/3;max-height:40vh}
}
</style>
</head>
<body>

<div id="loading">
  <div class="spin"></div>
  <div class="lt">LOADING OPTIONS CHAIN...</div>
</div>

<div class="hdr">
  <div class="hdr-logo">GEX<b>TERM</b></div>
  <div class="hdr-sep"></div>
  <div class="hdr-tabs">
    <button class="hdr-tab active" data-ticker="IBIT" onclick="switchTicker('IBIT')">IBIT</button>
    <button class="hdr-tab" data-ticker="ETHA" onclick="switchTicker('ETHA')">ETHA</button>
  </div>
  <div class="hdr-sep"></div>
  <div class="hdr-price" id="hdr-btc">---</div>
  <div class="hdr-sub" id="hdr-ibit"></div>
  <div class="hdr-sep"></div>
  <div class="hdr-regime" id="hdr-regime">---</div>
  <div class="hdr-conf" id="hdr-conf" style="display:none"></div>
  <div class="hdr-flow" id="hdr-flow" style="display:none"></div>
  <div class="hdr-right">
    <div class="hdr-ts" id="hdr-time"></div>
    <span id="hdr-freshness" style="display:none;color:var(--t3);font-size:9px;margin-left:6px"></span>
    <div class="hdr-sep"></div>
    <label style="color:var(--t3);font-size:10px;">DTE</label>
    <select id="dte-select" onchange="loadData()" style="background:var(--bg3);color:var(--t1);border:1px solid var(--border2);border-radius:2px;padding:2px 4px;font-family:var(--mono);font-size:10px;cursor:pointer">
      <option value="0-3" selected>0-3 DTE</option>
      <option value="4-7">4-7 DTE</option>
      <option value="8-14">8-14 DTE</option>
      <option value="15-30">15-30 DTE</option>
      <option value="31-45">31-45 DTE</option>
    </select>
    <span id="hdr-exp" style="color:var(--t3);font-size:9px"></span>
    <div class="hdr-sep"></div>
    <label id="src-label" style="color:var(--t3);font-size:10px;">SRC</label>
    <select id="src-select" onchange="setSource(this.value)" style="background:var(--bg3);color:var(--t1);border:1px solid var(--border2);border-radius:2px;padding:2px 4px;font-family:var(--mono);font-size:10px;cursor:pointer">
      <option value="all" selected>ALL</option>
      <option value="ibit">IBIT</option>
      <option value="deribit">DERIBIT</option>
    </select>
    <span id="hdr-deribit" style="display:none;color:var(--t3);font-size:9px"></span>
    <button class="hdr-btn" onclick="loadData()">REFRESH</button>
  </div>
</div>

<div class="grid">
  <div class="chart-area">
    <div id="tv-chart"></div>
    <div style="position:absolute;top:4px;right:4px;z-index:10;display:flex;align-items:center;gap:3px">
      <label style="color:var(--t3);font-size:9px">TF</label>
      <select id="tf-select" onchange="loadData()" style="background:var(--bg3);color:var(--t1);border:1px solid var(--border2);border-radius:2px;padding:2px 4px;font-family:var(--mono);font-size:9px;cursor:pointer">
        <option value="15m">15m</option>
        <option value="1h">1h</option>
        <option value="4h" selected>4h</option>
        <option value="1d">1d</option>
      </select>
    </div>
    <div class="chart-legend">
      <div class="chart-legend-item"><div class="chart-legend-line" style="border-color:#00dc82"></div>Call Wall<div class="chart-legend-tip">Strike with highest call GEX. Acts as resistance — dealers sell into rallies here. In positive gamma this is a hard ceiling.</div></div>
      <div class="chart-legend-item"><div class="chart-legend-line" style="border-color:#ff4060"></div>Put Wall<div class="chart-legend-tip">Strike with most negative put GEX. Acts as support — dealers buy dips here. In positive gamma this is a hard floor.</div></div>
      <div class="chart-legend-item"><div class="chart-legend-line" style="border-color:#ffb020;border-width:2px"></div>&#x3b3; Flip<div class="chart-legend-tip">Where net GEX crosses zero. Above = positive gamma (dealers dampen moves, range-bound). Below = negative gamma (dealers amplify moves, trending).</div></div>
      <div class="chart-legend-item"><div class="chart-legend-line dashed" style="border-color:#a78bfa"></div>Max Pain<div class="chart-legend-tip">Strike where option holders lose the most at expiry. Price gravitates here into expiration as dealers unwind hedges. Strongest pull in positive gamma.</div></div>
      <div class="chart-legend-item"><div class="chart-legend-line dashed" style="border-color:#3890ff88"></div>EM &#xb1;<div class="chart-legend-tip">Expected Move — the market's priced-in range from the ATM straddle (~68% probability). Price is expected to stay within these bounds by expiration.</div></div>
      <div class="chart-legend-item"><div class="chart-legend-line dashed" style="border-color:#00dc8244"></div>R1/R2<div class="chart-legend-tip">Secondary resistance levels — high-OI strikes above the call wall where dealer hedging creates friction against further upside.</div></div>
      <div class="chart-legend-item"><div class="chart-legend-line dashed" style="border-color:#ff406044"></div>S1/S2<div class="chart-legend-tip">Secondary support levels — high-OI strikes below the put wall where dealer hedging creates friction against further downside.</div></div>
      <div class="chart-legend-item"><div class="chart-legend-line dashed" style="border-color:#c084fc88"></div>&#x394; Flip<div class="chart-legend-tip">Price where net dealer delta crosses zero. Above = dealers must sell (resistive). Below = dealers must buy (supportive). Distinct from gamma flip.</div></div>
    </div>
  </div>
  <div class="outlook-row" id="outlook-sec">
    <div class="cell-label">Positioning Outlook <span style="font-size:8px;color:var(--t3);font-weight:400;letter-spacing:0;text-transform:none;margin-left:4px">forward-looking range funnel</span></div>
    <canvas id="outlook-chart"></canvas>
    <div class="outlook-legend">
      <span><span style="color:rgba(255,64,96,0.7)">━</span> Call wall</span>
      <span><span style="color:rgba(0,220,130,0.7)">━</span> Put wall</span>
      <span><span style="color:rgba(255,176,32,0.6)">╌</span> γ Flip</span>
      <span><span style="color:rgba(136,146,164,0.4)">╌</span> Max pain</span>
      <span><span style="color:rgba(168,139,250,0.5)">╌</span> EM</span>
      <span><span style="color:rgba(220,224,232,0.3)">╌</span> Spot</span>
      <span><span style="color:rgba(0,220,130,0.9)">◆</span> Venues agree</span>
      <span><span style="background:rgba(0,220,130,0.06);padding:0 4px;border-radius:1px">░</span> Pos γ</span>
      <span><span style="background:rgba(255,64,96,0.06);padding:0 4px;border-radius:1px">░</span> Neg γ</span>
    </div>
  </div>
  <div class="cell cell-gex">
    <div class="cell-label">
      <span class="cell-tab active" data-view="gex" onclick="setGexView('gex')">GEX Profile</span>
      <span class="cell-tab" data-view="oi" onclick="setGexView('oi')">Open Interest</span>
      <span style="margin-left:auto;display:flex;gap:2px;align-items:center">
        <select id="expiry-filter" onchange="setExpiryFilter(this.value)" style="font-family:var(--mono);font-size:8px;font-weight:600;letter-spacing:.4px;padding:1px 4px;border-radius:2px;border:1px solid var(--border2);background:var(--bg);color:var(--t2);cursor:pointer;outline:none">
          <option value="all">ALL EXP</option>
          <option value="1">NEAREST</option>
          <option value="2">NEXT 2</option>
          <option value="3">NEXT 3</option>
        </select>
      </span>
    </div>
    <canvas id="gex-chart"></canvas>
    <canvas id="oi-chart" style="display:none"></canvas>
  </div>
  <div class="cell cell-delta">
    <div class="cell-label">Dealer Delta Profile</div>
    <canvas id="delta-chart"></canvas>
  </div>
  <div class="cell cell-structure">
    <div class="cell-label">Structure <span style="font-size:7px;color:var(--t3);font-weight:400;letter-spacing:0;text-transform:none;margin-left:3px">30d wall evolution</span></div>
    <canvas id="structure-chart"></canvas>
    <div style="display:flex;gap:6px;padding:2px 0 0;align-items:center;justify-content:center;flex-wrap:wrap;flex-shrink:0">
      <span style="display:flex;align-items:center;gap:2px;font-size:7px;color:#8892a4"><span style="display:inline-block;width:12px;height:6px;background:rgba(0,220,130,0.12);border:1px solid rgba(0,220,130,0.55);border-radius:1px"></span>0-3d</span>
      <span style="display:flex;align-items:center;gap:2px;font-size:7px;color:#8892a4"><span style="display:inline-block;width:12px;height:6px;background:rgba(0,180,220,0.10);border:1px solid rgba(0,180,220,0.45);border-radius:1px"></span>4-7d</span>
      <span style="display:flex;align-items:center;gap:2px;font-size:7px;color:#8892a4"><span style="display:inline-block;width:12px;height:6px;background:rgba(56,144,255,0.08);border:1px solid rgba(56,144,255,0.35);border-radius:1px"></span>8-14d</span>
      <span style="display:flex;align-items:center;gap:2px;font-size:7px;color:#8892a4"><span style="display:inline-block;width:12px;height:6px;background:rgba(255,176,32,0.06);border:1px solid rgba(255,176,32,0.25);border-radius:1px"></span>15-30d</span>
      <span style="display:flex;align-items:center;gap:2px;font-size:7px;color:#8892a4"><span style="display:inline-block;width:12px;height:6px;background:rgba(168,139,250,0.06);border:1px solid rgba(168,139,250,0.25);border-radius:1px"></span>31-45d</span>
      <span style="display:flex;align-items:center;gap:2px;font-size:7px;color:#8892a4"><span style="display:inline-block;width:12px;height:2px;background:rgba(220,224,232,0.9)"></span>Spot</span>
      <span style="display:flex;align-items:center;gap:2px;font-size:7px;color:#8892a4"><span style="display:inline-block;width:12px;height:0;border-top:1px dashed rgba(255,176,32,0.6)"></span>&gamma; Flip</span>
      <span style="display:flex;align-items:center;gap:2px;font-size:7px;color:#8892a4"><span style="color:rgba(0,220,130,0.9);font-size:8px">&#9670;</span>Venue agree</span>
    </div>
  </div>
  <div class="cell cell-flow">
    <div class="cell-label">ETF Flows</div>
    <canvas id="flow-chart"></canvas>
  </div>
  <div class="right" id="sidebar"></div>
  <div class="ai-panel" id="ai-panel"></div>
</div>

<script>
let gexChart=null,oiChart=null,flowChart=null,deltaChart=null,tvChart=null,tvSeries=null,priceLines=[],outlookChart=null,structureChart=null;
let aiData=null;
let aiUnsaved=false;
let btcWs=null;
let currentTicker='IBIT';
let _loadSeq=0;
let expiryFilter='all';
let currentSource='all';
const TICKER_WS={IBIT:'btcusdt',ETHA:'ethusdt'};
const fmt=n=>n>=1000?`$${n.toLocaleString('en-US',{maximumFractionDigits:0})}`:`$${n.toFixed(2)}`;
const fB=n=>`$${Math.round(n).toLocaleString()}`;
const fO=n=>n.toLocaleString();
const fP=n=>`${n>=0?'+':''}${n.toFixed(1)}%`;
const fG=n=>{const a=Math.abs(n);if(a>=1e6)return `${n<0?'-':''}$${(a/1e6).toFixed(1)}M`;if(a>=1e3)return `${n<0?'-':''}$${(a/1e3).toFixed(0)}K`;return `$${Math.round(n)}`};
const esc=s=>{if(!s)return '';const d=document.createElement('div');d.textContent=s;return d.innerHTML};

function setExpiryFilter(val){
  expiryFilter=val;
  if(window._lastData)renderGEX(window._lastData);
}

let gexView='gex';
function setGexView(view){
  gexView=view;
  document.querySelectorAll('.cell-gex .cell-tab').forEach(t=>t.classList.toggle('active',t.dataset.view===view));
  document.getElementById('gex-chart').style.display=view==='gex'?'':'none';
  document.getElementById('oi-chart').style.display=view==='oi'?'':'none';
  if(view==='oi'&&window._lastData){try{renderOI(window._lastData)}catch(e){console.warn('OI:',e)}}
  if(view==='gex'&&window._lastData){try{renderGEX(window._lastData)}catch(e){console.warn('GEX:',e)}}
}

function setSource(val){
  currentSource=val;
  if(window._lastData){
    renderGEX(window._lastData);
    if(gexView==='oi') renderOI(window._lastData);
    renderSidebar(window._lastData);
    updateChartOverlay(window._lastData);
  }
}

let overlayMin=null,overlayMax=null;
function updateChartOverlay(data){
  try{
    if(!tvSeries)return;
    clearLines();
    const bps=data.btc_per_share;
    // Pick levels based on current source
    let cw,pw,gf,mp,support,resistance;
    if(currentSource==='deribit'&&data.deribit_levels_btc){
      const dl=data.deribit_levels_btc;
      cw=dl.call_wall; pw=dl.put_wall; gf=dl.gamma_flip; mp=dl.max_pain;
      support=dl.support||[]; resistance=dl.resistance||[];
    }else if(currentSource==='all'&&data.combined_levels_btc){
      const cl=data.combined_levels_btc;
      cw=cl.call_wall; pw=cl.put_wall; gf=cl.gamma_flip; mp=cl.max_pain;
      support=cl.support||[]; resistance=cl.resistance||[];
    }else{
      cw=data.levels.call_wall/bps; pw=data.levels.put_wall/bps;
      gf=data.levels.gamma_flip/bps; mp=data.levels.max_pain/bps;
      support=(data.levels.support||[]).map(s=>s/bps);
      resistance=(data.levels.resistance||[]).map(r=>r/bps);
    }
    // Collect all level prices to compute visible range
    const allLevels=[cw,pw,gf,mp,...support,...resistance];
    if(data.expected_move){
      allLevels.push(data.expected_move.upper_btc,data.expected_move.lower_btc);
    }
    if(currentSource!=='deribit'&&data.delta_flip_points){
      data.delta_flip_points.forEach(fp=>allLevels.push(fp.price_btc));
    }
    const valid=allLevels.filter(v=>v&&isFinite(v));
    overlayMin=valid.length?Math.min(...valid):null;
    overlayMax=valid.length?Math.max(...valid):null;

    addLine(cw,'#00dc82','Call Wall',1,2);
    addLine(pw,'#ff4060','Put Wall',1,2);
    addLine(gf,'#ffb020','\u03b3 Flip',2,2);
    addLine(mp,'#a78bfa','MaxPain',1,3);
    if(data.expected_move){
      addLine(data.expected_move.upper_btc,'#3890ff44','EM+',1,3);
      addLine(data.expected_move.lower_btc,'#3890ff44','EM-',1,3);
    }
    support.forEach((s,i)=>{if(s!==pw)addLine(s,'#ff406044',`S${i+1}`,1,3)});
    resistance.forEach((r,i)=>{if(r!==cw)addLine(r,'#00dc8244',`R${i+1}`,1,3)});
    if(currentSource!=='deribit'&&data.delta_flip_points&&data.delta_flip_points.length){
      data.delta_flip_points.forEach((fp,i)=>{
        addLine(fp.price_btc,'#c084fc',`\u0394 Flip${data.delta_flip_points.length>1?' '+(i+1):''}`,1,4);
      });
    }
  }catch(e){console.warn('Chart overlay:',e)}
}

function generateExpiryPalette(count){
  const palette=[];
  for(let i=0;i<count;i++){
    const t=count>1?i/(count-1):0;
    const opacity=1.0-t*0.7; // nearest=1.0, farthest=0.3
    palette.push({
      pos:`rgba(0,220,130,${opacity.toFixed(2)})`,
      neg:`rgba(255,64,96,${opacity.toFixed(2)})`
    });
  }
  return palette;
}

function switchTicker(tk){
  if(tk===currentTicker)return;
  currentTicker=tk;
  if(btcWs){btcWs.close();btcWs=null}
  document.querySelectorAll('.hdr-tab').forEach(b=>b.classList.toggle('active',b.dataset.ticker===tk));
  aiData=null;
  aiUnsaved=false;
  loadData();
  loadAnalysis();
}

function initTV(){
  if(typeof LightweightCharts==='undefined')return;
  const c=document.getElementById('tv-chart');
  tvChart=LightweightCharts.createChart(c,{
    layout:{background:{color:'#06080c'},textColor:'#4a5568',fontFamily:'IBM Plex Mono',fontSize:10},
    grid:{vertLines:{color:'#111620'},horzLines:{color:'#111620'}},
    crosshair:{mode:0,vertLine:{color:'#3890ff',width:1,style:2},horzLine:{color:'#3890ff',width:1,style:2}},
    rightPriceScale:{borderColor:'#1c2230',scaleMargins:{top:0.1,bottom:0.1}},
    timeScale:{borderColor:'#1c2230',timeVisible:true,secondsVisible:false},
    handleScroll:true,handleScale:true
  });
  tvSeries=tvChart.addCandlestickSeries({
    upColor:'#00dc82',downColor:'#ff4060',
    borderUpColor:'#00dc82',borderDownColor:'#ff4060',
    wickUpColor:'#00dc8266',wickDownColor:'#ff406066',
    autoscaleInfoProvider:orig=>{
      const res=orig();
      if(overlayMin!==null&&overlayMax!==null&&res&&res.priceRange){
        res.priceRange.minValue=Math.min(res.priceRange.minValue,overlayMin);
        res.priceRange.maxValue=Math.max(res.priceRange.maxValue,overlayMax);
      }
      return res;
    }
  });
  new ResizeObserver(()=>tvChart.applyOptions({width:c.clientWidth,height:c.clientHeight})).observe(c);
}

function startCryptoWs(tf,wsSym){
  if(btcWs){btcWs.close();btcWs=null}
  if(!tvSeries)return;
  const wsUrls=[
    `wss://stream.binance.com:9443/ws/${wsSym}@kline_${tf}`,
    `wss://stream.binance.us:9443/ws/${wsSym}@kline_${tf}`
  ];
  let idx=0,retryDelay=1000;
  function connect(){
    if(idx>=wsUrls.length){
      console.warn(`${wsSym} WebSocket: all sources failed, retrying in ${retryDelay/1000}s`);
      setTimeout(()=>{idx=0;connect()},retryDelay);
      retryDelay=Math.min(retryDelay*2,60000);
      return;
    }
    const ws=new WebSocket(wsUrls[idx]);
    ws.onopen=()=>{console.log(`${wsSym} WebSocket connected:`,wsUrls[idx]);retryDelay=1000};
    ws.onmessage=e=>{
      try{
        const msg=JSON.parse(e.data);
        if(!msg.k)return;
        const k=msg.k;
        tvSeries.update({time:Math.floor(k.t/1000),open:+k.o,high:+k.h,low:+k.l,close:+k.c});
        const price=fB(+k.c);
        const hdr=document.getElementById('hdr-btc');
        if(hdr.textContent!==price)hdr.textContent=price;
      }catch(err){}
    };
    ws.onerror=()=>{ws.close()};
    ws.onclose=()=>{
      if(btcWs===ws){idx++;connect()}
    };
    btcWs=ws;
  }
  connect();
}

async function loadBTC(){
  const tf=document.getElementById('tf-select').value;
  const wsSym=TICKER_WS[currentTicker]||'btcusdt';
  const binSym=wsSym.toUpperCase();
  // Try backend API first (90-day history from SQLite)
  try{
    const r=await fetch(`/api/candles?ticker=${currentTicker}&tf=${tf}`);
    if(r.ok){
      const d=await r.json();
      if(Array.isArray(d)&&d.length>0){
        tvSeries.setData(d);
        startCryptoWs(tf,wsSym);
        return d;
      }
    }
  }catch(e){console.warn('Backend candles unavailable, falling back to Binance:',e)}
  // Fallback: direct Binance fetch
  const limits={'15m':960,'1h':720,'4h':360,'1d':365};
  const lim=limits[tf]||720;
  const urls=[`https://api.binance.us/api/v3/klines?symbol=${binSym}&interval=${tf}&limit=${lim}`,`https://api.binance.com/api/v3/klines?symbol=${binSym}&interval=${tf}&limit=${lim}`];
  for(const url of urls){
    try{
      const r=await fetch(url);
      if(!r.ok)continue;
      const raw=await r.json();
      if(!Array.isArray(raw))continue;
      const d=raw.map(k=>({time:Math.floor(k[0]/1000),open:+k[1],high:+k[2],low:+k[3],close:+k[4]}));
      tvSeries.setData(d);
      startCryptoWs(tf,wsSym);
      return d;
    }catch(e){console.warn('Candle source failed:',url,e)}
  }
  return[];
}

function clearLines(){
  if(!tvSeries)return;
  priceLines.forEach(l=>{try{tvSeries.removePriceLine(l)}catch(e){}});
  priceLines=[];
}
function addLine(price,color,title,w=1,s=2){
  if(!tvSeries)return;
  try{const l=tvSeries.createPriceLine({price,color,lineWidth:w,lineStyle:s,axisLabelVisible:true,title});priceLines.push(l)}catch(e){}
}

function renderGEX(data){
  if(typeof Chart==='undefined')return;
  const ctx=document.getElementById('gex-chart');
  if(gexChart)gexChart.destroy();
  const labels=data.gex_chart.map(d=>fB(d.btc));
  const datasets=[];
  const hasDeribit=data.deribit_available;

  if(currentSource==='all'&&hasDeribit){
    // Stacked: IBIT + Deribit
    const ibitVals=data.gex_chart.map(d=>d.ibit_gex||d.net_gex);
    const deribitVals=data.gex_chart.map(d=>d.deribit_gex||0);
    datasets.push({
      label:'IBIT',data:ibitVals,
      backgroundColor:ibitVals.map(v=>v>=0?'#00dc82cc':'#ff4060cc'),
      borderWidth:0,borderRadius:1,barPercentage:.85
    });
    datasets.push({
      label:'Deribit',data:deribitVals,
      backgroundColor:deribitVals.map(v=>v>=0?'#00dc8266':'#ff406066'),
      borderWidth:0,borderRadius:0,barPercentage:.85
    });
  } else if(currentSource==='deribit'&&hasDeribit){
    // Deribit only
    const vals=data.gex_chart.map(d=>d.deribit_gex||0);
    datasets.push({
      label:'Deribit',data:vals,
      backgroundColor:vals.map(v=>v>=0?'#00dc82aa':'#ff4060aa'),
      borderWidth:0,borderRadius:1,barPercentage:.85
    });
  } else {
    // IBIT only — per-expiry stacked (existing behavior)
    const meta=data.expiry_meta||[];
    let exps=meta.map(m=>m.exp);
    if(expiryFilter!=='all'){
      const n=parseInt(expiryFilter);
      exps=exps.slice(0,n);
    }
    const palette=generateExpiryPalette(exps.length||1);
    exps.forEach((exp,ei)=>{
      const dteLabel=meta.find(m=>m.exp===exp);
      const label=dteLabel?`${dteLabel.dte}d (${exp.slice(5)})`:`${exp.slice(5)}`;
      const vals=data.gex_chart.map(d=>{
        const eb=d.expiry_breakdown||{};
        return eb[exp]?eb[exp].net_gex:0;
      });
      const cols=vals.map(v=>v>=0?palette[ei].pos:palette[ei].neg);
      datasets.push({
        label,data:vals,backgroundColor:cols,borderWidth:0,borderRadius:ei===0?1:0,barPercentage:.85
      });
    });
    // Fallback if no expiry breakdown available
    if(datasets.length===0){
      const vals=data.gex_chart.map(d=>currentSource==='ibit'?(d.ibit_gex||d.net_gex):d.net_gex);
      const cols=vals.map(v=>v>=0?'#00dc82cc':'#ff4060cc');
      datasets.push({label:'GEX',data:vals,backgroundColor:cols,borderWidth:0,borderRadius:1,barPercentage:.85});
    }
  }
  gexChart=new Chart(ctx,{
    type:'bar',
    data:{labels,datasets},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{
        legend:{display:true,position:'top',align:'end',labels:{color:'#4a5568',font:{size:8,family:'IBM Plex Mono'},boxWidth:8,boxHeight:8,padding:6}},
        tooltip:{callbacks:{
          title:i=>i[0].label,
          afterBody:function(items){
            const idx=items[0].dataIndex;
            const d=data.gex_chart[idx];
            const lines=[`Net GEX: ${fG(d.net_gex)}`];
            if(d.ibit_gex!=null&&d.deribit_gex!=null&&hasDeribit)lines.push(`IBIT: ${fG(d.ibit_gex)} | Deribit: ${fG(d.deribit_gex)}`);
            if(d.active_gex!=null)lines.push(`Active GEX: ${fG(d.active_gex)}`);
            if(d.total_volume)lines.push(`Volume: ${d.total_volume.toLocaleString()}`);
            return lines;
          },
          label:()=>null
        }}
      },
      scales:{
        x:{stacked:true,ticks:{color:'#4a5568',font:{size:8,family:'IBM Plex Mono'},maxTicksLimit:12,maxRotation:0},grid:{color:'#111620'},border:{color:'#1c2230'}},
        y:{stacked:true,ticks:{color:'#4a5568',font:{size:8,family:'IBM Plex Mono'},callback:v=>fG(v)},grid:{color:'#111620'},border:{color:'#1c2230'}}
      }
    }
  });
}

function renderOI(data){
  if(typeof Chart==='undefined')return;
  const ctx=document.getElementById('oi-chart');
  if(oiChart)oiChart.destroy();
  const labels=data.gex_chart.map(d=>fB(d.btc));
  oiChart=new Chart(ctx,{
    type:'bar',
    data:{labels,datasets:[
      {label:'Calls',data:data.gex_chart.map(d=>d.call_oi),backgroundColor:'#00dc8288',borderRadius:1,barPercentage:.85},
      {label:'Puts',data:data.gex_chart.map(d=>d.put_oi),backgroundColor:'#ff406088',borderRadius:1,barPercentage:.85}
    ]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:true,position:'top',align:'end',labels:{color:'#4a5568',font:{size:8,family:'IBM Plex Mono'},boxWidth:8,boxHeight:8,padding:6}}},
      scales:{
        x:{ticks:{color:'#4a5568',font:{size:8,family:'IBM Plex Mono'},maxTicksLimit:12,maxRotation:0},grid:{color:'#111620'},border:{color:'#1c2230'}},
        y:{ticks:{color:'#4a5568',font:{size:8,family:'IBM Plex Mono'},callback:v=>`${(v/1000).toFixed(0)}K`},grid:{color:'#111620'},border:{color:'#1c2230'}}
      }
    }
  });
}

function renderFlowChart(flows){
  if(typeof Chart==='undefined')return;
  const ctx=document.getElementById('flow-chart');
  if(!flows || !flows.length){if(flowChart){flowChart.destroy();flowChart=null}return}
  if(flowChart)flowChart.destroy();
  const labels=flows.map(d=>d.date.slice(5));
  const totalVals=flows.map(d=>(d.total_flow!=null?(d.total_flow/1e6):(d.flow||0)/1e6));
  const ibitVals=flows.map(d=>(d.flow||0)/1e6);
  const totalColors=totalVals.map(v=>v>=0?'#00dc8266':'#ff406066');
  const ibitColors=ibitVals.map(v=>v>=0?'#00dc82cc':'#ff4060cc');
  const hasTotal=flows.some(d=>d.total_flow!=null);
  const datasets=[];
  if(hasTotal){
    datasets.push({label:'Total BTC ETF ($M)',data:totalVals,backgroundColor:totalColors,borderWidth:0,borderRadius:1,barPercentage:.95,order:2});
    datasets.push({label:'IBIT ($M)',data:ibitVals,backgroundColor:ibitColors,borderWidth:0,borderRadius:1,barPercentage:.5,order:1});
  }else{
    datasets.push({label:'IBIT ($M)',data:ibitVals,backgroundColor:ibitColors,borderWidth:0,borderRadius:1,barPercentage:.85});
  }
  flowChart=new Chart(ctx,{
    type:'bar',
    data:{labels,datasets},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:hasTotal,labels:{color:'#8896a6',font:{size:8,family:'IBM Plex Mono'},boxWidth:8,padding:4}},tooltip:{callbacks:{label:i=>`${i.dataset.label}: ${i.raw>=0?'+':''}${i.raw.toFixed(1)}M`}}},
      scales:{
        x:{ticks:{color:'#4a5568',font:{size:8,family:'IBM Plex Mono'},maxTicksLimit:10,maxRotation:0},grid:{color:'#111620'},border:{color:'#1c2230'}},
        y:{ticks:{color:'#4a5568',font:{size:8,family:'IBM Plex Mono'},callback:v=>`${v>=0?'+':''}${v.toFixed(0)}M`},grid:{color:'#111620'},border:{color:'#1c2230'}}
      }
    }
  });
}

function renderDealerDelta(data){
  if(typeof Chart==='undefined')return;
  const ctx=document.getElementById('delta-chart');
  if(deltaChart)deltaChart.destroy();
  const profile=data.dealer_delta_profile;
  if(!profile||!profile.length){deltaChart=null;return}

  const labels=profile.map(d=>fB(d.price_btc));
  const values=profile.map(d=>d.net_dealer_delta);
  const colors=values.map(v=>v<0?'#00dc82cc':'#ff4060cc');

  deltaChart=new Chart(ctx,{
    type:'bar',
    data:{labels,datasets:[{
      label:'Dealer Delta',
      data:values,
      backgroundColor:colors,
      borderWidth:0,borderRadius:1,barPercentage:0.85
    }]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{
          label:i=>{
            const v=i.raw;
            const dir=v<0?'BUY':'SELL';
            return `Dealers ${dir} ${fG(Math.abs(v))}`;
          }
        }}
      },
      scales:{
        x:{ticks:{color:'#4a5568',font:{size:8,family:'IBM Plex Mono'},maxTicksLimit:10,maxRotation:0},grid:{color:'#111620'},border:{color:'#1c2230'}},
        y:{ticks:{color:'#4a5568',font:{size:8,family:'IBM Plex Mono'},callback:v=>`${v<0?'-':''}${fG(Math.abs(v))}`},grid:{color:'#111620'},border:{color:'#1c2230'}}
      }
    }
  });
}

function renderSidebar(data){
  const lv=data.levels,bps=data.btc_per_share;
  const hasDeribit=data.deribit_available;

  // Pick the right levels based on source toggle
  let useLv=lv, useBtcDirect=false, srcLabel='';
  if(currentSource==='all'&&hasDeribit&&data.combined_levels_btc){
    useLv=data.combined_levels_btc; useBtcDirect=true; srcLabel=' (IBIT+Deribit)';
  } else if(currentSource==='deribit'&&hasDeribit&&data.deribit_levels_btc){
    useLv=data.deribit_levels_btc; useBtcDirect=true; srcLabel=' (Deribit)';
  } else {
    srcLabel=hasDeribit?' (IBIT)':'';
  }

  // Price formatting: BTC-direct levels are already in BTC, IBIT levels need conversion
  const b=useBtcDirect?s=>fB(s):s=>fB(s/bps);
  const dp=useBtcDirect?s=>((s-data.btc_spot)/data.btc_spot*100):s=>((s-data.spot)/data.spot*100);
  const db=s=>{const d=dp(s);return `<span class="kl-dist ${d>=0?'d-up':'d-dn'}">${d>=0?'+':''}${d.toFixed(1)}%</span>`};
  const isNeg=useLv.regime==='negative_gamma';
  let h='';

  // Regime banner
  h+=`<div class="sec"><div class="regime-banner ${isNeg?'rbn':'rbp'}">`;
  if(isNeg){
    h+=`<strong>NEGATIVE GAMMA</strong>Dealers amplify moves. Fading extremes is risky. Flip at ${b(useLv.gamma_flip)}.`;
  }else{
    h+=`<strong>POSITIVE GAMMA</strong>Dealers dampen moves. Fade extremes within range.`;
  }
  h+=`</div>`;

  // Deribit OI badge
  if(hasDeribit){
    const dOi=data.deribit_oi_btc||0;
    h+=`<div style="display:flex;gap:6px;padding:2px 0;font-size:9px;color:var(--t3)">`;
    h+=`<span>Deribit: ${Math.round(dOi).toLocaleString()} BTC OI</span>`;
    h+=`</div>`;
  }

  // Expected move
  if(data.expected_move){
    const em=data.expected_move;
    h+=`<div class="em-bar"><div><div class="em-l">EM (${em.dte}d)</div><div class="em-v" style="color:var(--blue)">\u00b1${em.pct.toFixed(1)}%</div></div>`;
    h+=`<div style="text-align:right"><div class="em-l">Range</div><div class="em-v">${fB(em.lower_btc)} \u2014 ${fB(em.upper_btc)}</div></div></div>`;
  }

  // Range visual (positive gamma only)
  if(!isNeg){
    const cw=useLv.call_wall,pw=useLv.put_wall;
    const spotRef=useBtcDirect?data.btc_spot:data.spot;
    const rangeW=((cw-pw)/spotRef*100).toFixed(1);
    const pct=Math.min(100,Math.max(0,((spotRef-pw)/(cw-pw))*100));
    h+=`<div class="range-box"><div style="display:flex;justify-content:space-between;font-size:9px;color:var(--t3)"><span>Range ${rangeW}%${srcLabel}</span></div>`;
    h+=`<div class="range-track"><div class="range-needle" style="left:${pct}%"></div></div>`;
    h+=`<div class="range-ends"><span style="color:var(--green)">Long ${b(pw)}</span><span style="color:var(--red)">Short ${b(cw)}</span></div></div>`;
  }
  h+=`</div>`;

  // Key Levels
  h+=`<div class="sec"><div class="sec-title"><span class="dot" style="background:var(--blue)"></span>Key Levels${srcLabel}</div>`;
  const traj=lv.level_trajectory||{};
  [{n:'Call Wall',s:useLv.call_wall,c:'var(--green)',tk:'call_wall'},{n:'Gamma Flip',s:useLv.gamma_flip,c:'var(--amber)',tk:'gamma_flip'},{n:'Max Pain',s:useLv.max_pain,c:'var(--purple)',tk:null},{n:'Put Wall',s:useLv.put_wall,c:'var(--red)',tk:'put_wall'}].forEach(k=>{
    let badge='';
    if(!useBtcDirect&&k.tk&&traj[k.tk]){
      const t=traj[k.tk];
      const sc=t.status==='STRENGTHENING'?'sld-b':t.status==='WEAKENING'?'sld-d':'sld-s';
      const ar=t.status==='STRENGTHENING'?'\u2191':t.status==='WEAKENING'?'\u2193':'\u2194';
      badge=`<span class="sl-delta ${sc}" style="margin-left:4px">${ar}${t.status}</span>`;
      if(t.dominant_expiry_dte!=null)badge+=`<span style="font-size:8px;color:var(--t3);margin-left:3px">${t.dominant_expiry_dte}d</span>`;
    }
    if(useBtcDirect){
      h+=`<div class="kl-row"><span class="kl-name" style="color:${k.c}">${k.n}${badge}</span><div class="kl-vals"><span class="kl-btc">${b(k.s)}</span>${db(k.s)}</div></div>`;
    }else{
      h+=`<div class="kl-row"><span class="kl-name" style="color:${k.c}">${k.n}${badge}</span><div class="kl-vals"><span class="kl-btc">${b(k.s)}</span><span class="kl-ibit">$${k.s.toFixed(2)}</span>${db(k.s)}</div></div>`;
    }
  });
  h+=`</div>`;

  // Significant Levels
  if(data.significant_levels.length){
    h+=`<div class="sec"><div class="sec-title"><span class="dot" style="background:var(--amber)"></span>Significant Levels</div>`;
    data.significant_levels.forEach(sl=>{
      let dh='';
      if(sl.oi_delta){
        const cls=sl.oi_delta.status==='BUILDING'?'sld-b':sl.oi_delta.status==='DECAYING'?'sld-d':'sld-s';
        const ar=sl.oi_delta.delta>0?'\u2191':'\u2193';
        dh=`<span class="sl-delta ${cls}">${ar}${Math.abs(sl.oi_delta.delta).toLocaleString()} ${sl.oi_delta.status}</span>`;
      }
      h+=`<div class="sl-row"><div class="sl-top"><span><span class="sl-price">${fB(sl.btc)}</span> ${db(useBtcDirect?sl.btc:sl.strike)}</span><span class="sl-oi">${fO(sl.total_oi)}${dh}</span></div>`;
      h+=`<div class="sl-beh">${esc(sl.behavior)}</div>`;
      if(sl.greeks_note)h+=`<div class="sl-greeks">${esc(sl.greeks_note)}</div>`;
      h+=`</div>`;
    });
    h+=`</div>`;
  }

  // Breakout
  h+=`<div class="sec"><div class="sec-title"><span class="dot" style="background:var(--purple)"></span>Breakout</div>`;
  const bo=data.breakout;
  if(bo.up_score>0){
    const dots=Array.from({length:5},(_,i)=>`<div class="bo-dot ${i<bo.up_score?'bo-dot-g':'bo-dot-e'}"></div>`).join('');
    h+=`<div class="bo-dir bo-up"><div class="bo-hdr"><span class="bo-label" style="color:var(--green)">\u25b2 UP (${bo.up_score})</span><div class="bo-dots">${dots}</div></div>`;
    bo.up_signals.forEach(s=>{h+=`<div class="bo-sig">\u2022 ${esc(s)}</div>`});
    if(bo.up_targets.length)h+=`<div class="bo-tgt">Targets: ${bo.up_targets.map(t=>fB(t.btc)).join(', ')}</div>`;
    h+=`</div>`;
  }
  if(bo.down_score>0){
    const dots=Array.from({length:5},(_,i)=>`<div class="bo-dot ${i<bo.down_score?'bo-dot-r':'bo-dot-e'}"></div>`).join('');
    h+=`<div class="bo-dir bo-dn"><div class="bo-hdr"><span class="bo-label" style="color:var(--red)">\u25bc DN (${bo.down_score})</span><div class="bo-dots">${dots}</div></div>`;
    bo.down_signals.forEach(s=>{h+=`<div class="bo-sig">\u2022 ${esc(s)}</div>`});
    if(bo.down_targets.length)h+=`<div class="bo-tgt">Targets: ${bo.down_targets.map(t=>fB(t.btc)).join(', ')}</div>`;
    h+=`</div>`;
  }
  if(!bo.up_score&&!bo.down_score)h+=`<div style="font-size:10px;color:var(--t3)">No breakout signals</div>`;
  const bc=bo.bias==='upside'?'var(--green)':bo.bias==='downside'?'var(--red)':'var(--t3)';
  const bt=bo.bias==='upside'?'\u25b2 BIAS: UPSIDE':bo.bias==='downside'?'\u25bc BIAS: DOWNSIDE':'\u2014 BALANCED';
  h+=`<div class="bias-box" style="color:${bc}">${bt}</div>`;
  if(bo.em_note)h+=`<div style="font-size:9px;color:var(--amber);margin-top:4px;padding:3px 6px;background:var(--amber-bg);border:1px solid rgba(255,176,32,.15);border-radius:2px">\u26a0 ${esc(bo.em_note)}</div>`;
  h+=`</div>`;

  // Dealer Flow Forecast (Vanna + Charm)
  if(data.flow_forecast){
    const ff=data.flow_forecast;
    h+=`<div class="sec"><div class="sec-title"><span class="dot" style="background:var(--purple)"></span>Dealer Flows</div>`;

    // Overnight charm
    const ch=ff.charm;
    h+=`<div class="ff-box"><div class="ff-hdr">\u23f0 Overnight (Charm)</div>`;
    if(ch.strength==='negligible'){
      h+=`<div class="ff-negl">Negligible charm — no meaningful overnight delta shift</div>`;
    }else{
      h+=`<div class="ff-row"><span class="ffl">Dealers must</span><span class="ff-dir ${ch.direction==='buy'?'ff-buy':'ff-sell'}">${ch.direction.toUpperCase()} $${Math.abs(ch.net_notional).toLocaleString(undefined,{maximumFractionDigits:0})}</span></div>`;
      h+=`<div class="ff-row"><span class="ffl">Impact</span><span class="ffv">${ch.strength}</span></div>`;
    }
    h+=`</div>`;

    // Vanna scenarios
    const vn=ff.vanna;
    h+=`<div class="ff-box"><div class="ff-hdr">\u26a1 Vol Scenarios (Vanna)</div>`;
    if(vn.strength==='negligible'){
      h+=`<div class="ff-negl">Negligible vanna — IV moves won't trigger significant rebalancing</div>`;
    }else{
      h+=`<div class="ff-scenario"><span class="ffs-l">IV -5pts (crush)</span><span class="ffs-v"><span class="ff-dir ${vn.crush_scenario.direction==='buy'?'ff-buy':'ff-sell'}">${vn.crush_scenario.direction.toUpperCase()} $${Math.abs(vn.crush_scenario.notional).toLocaleString(undefined,{maximumFractionDigits:0})}</span></span></div>`;
      h+=`<div class="ff-scenario"><span class="ffs-l">IV +5pts (spike)</span><span class="ffs-v"><span class="ff-dir ${vn.spike_scenario.direction==='buy'?'ff-buy':'ff-sell'}">${vn.spike_scenario.direction.toUpperCase()} $${Math.abs(vn.spike_scenario.notional).toLocaleString(undefined,{maximumFractionDigits:0})}</span></span></div>`;
      h+=`<div class="ff-row"><span class="ffl">Sensitivity</span><span class="ffv">${vn.strength}</span></div>`;
    }
    h+=`</div>`;

    // Combined overnight
    const ov=ff.overnight;
    if(Math.abs(ov.net_notional)>1000){
      const ovDir=ov.direction==='buy'?'ff-buy':'ff-sell';
      h+=`<div class="ff-box"><div class="ff-hdr">\u{1f303} Net Overnight (Charm + Vol Decay)</div>`;
      h+=`<div class="ff-row"><span class="ffl">Combined</span><span class="ff-dir ${ovDir}">${ov.direction.toUpperCase()} $${Math.abs(ov.net_notional).toLocaleString(undefined,{maximumFractionDigits:0})}</span></div>`;
      h+=`</div>`;
    }

    h+=`<div class="ff-note">${esc(ff.regime_note)}</div>`;
    h+=`</div>`;
  }

  // Dealer Hedging Pressure (Scenario Analysis)
  if(data.dealer_delta_briefing){
    const dd=data.dealer_delta_briefing;
    h+=`<div class="sec"><div class="sec-title"><span class="dot" style="background:var(--purple)"></span>Dealer Hedging Pressure</div>`;

    // Current delta
    const curDelta=useLv.net_dealer_delta;
    const curDir=curDelta<0?'ff-buy':'ff-sell';
    const curLabel=curDelta<0?'BUYING':'SELLING';
    h+=`<div class="ff-box"><div class="ff-hdr">Current Position</div>`;
    h+=`<div class="ff-row"><span class="ffl">At spot</span><span class="ff-dir ${curDir}">${curLabel} ${fG(Math.abs(curDelta))}</span></div>`;
    h+=`</div>`;

    // Delta flip points
    if(data.delta_flip_points&&data.delta_flip_points.length){
      h+=`<div class="ff-box"><div class="ff-hdr">Delta Flip Points</div>`;
      data.delta_flip_points.forEach(fp=>{
        const relPct=((fp.price_ibit-data.spot)/data.spot*100);
        const distStr=`${relPct>=0?'+':''}${relPct.toFixed(1)}%`;
        h+=`<div class="ff-row"><span class="ffl">${fB(fp.price_btc)} <span style="color:var(--t3)">${distStr}</span></span><span class="ffv">${fp.from_direction} \u2192 ${fp.to_direction}</span></div>`;
      });
      h+=`</div>`;
    }

    // Key level deltas
    if(dd.key_level_deltas){
      h+=`<div class="ff-box"><div class="ff-hdr">At Key Levels</div>`;
      const kld=dd.key_level_deltas;
      [['Call Wall',lv.call_wall,kld.call_wall],
       ['\u03b3 Flip',lv.gamma_flip,kld.gamma_flip],
       ['Put Wall',lv.put_wall,kld.put_wall]].forEach(([name,strike,delta])=>{
        if(delta!=null){
          const dir=delta<0?'ff-buy':'ff-sell';
          const label=delta<0?'BUY':'SELL';
          const btcStr=fB(strike/bps);
          h+=`<div class="ff-row"><span class="ffl">${name} ${btcStr}</span><span class="ff-dir ${dir}">${label} ${fG(Math.abs(delta))}</span></div>`;
        }
      });
      h+=`</div>`;
    }

    // Morning briefing
    if(dd.morning_take){
      h+=`<div class="ff-note">${esc(dd.morning_take)}</div>`;
    }

    h+=`</div>`;
  }

  // OI Changes
  if(data.oi_changes){
    const oc=data.oi_changes;
    let interp='';
    if(oc.put_delta>0&&oc.call_delta<0)interp='\u2192 Bearish positioning';
    else if(oc.call_delta>0&&oc.put_delta<0)interp='\u2192 Bullish positioning';
    else if(oc.call_delta>0&&oc.put_delta>0)interp='\u2192 Hedging increasing';
    else interp='\u2192 Derisking / runoff';
    h+=`<div class="sec"><div class="oi-box"><div class="oi-hdr">OI \u0394 vs ${oc.prev_date}</div>`;
    h+=`<div class="oi-r"><span>Total</span><span>${oc.total_delta>=0?'+':''}${fO(oc.total_delta)} (${fP(oc.total_pct)})</span></div>`;
    h+=`<div class="oi-r"><span>Calls</span><span>${oc.call_delta>=0?'+':''}${fO(oc.call_delta)}</span></div>`;
    h+=`<div class="oi-r"><span>Puts</span><span>${oc.put_delta>=0?'+':''}${fO(oc.put_delta)}</span></div>`;
    h+=`<div class="oi-interp">${interp}</div></div></div>`;
  }

  // ETF Fund Flows
  if(data.etf_flows){
    const fl=data.etf_flows;
    const isIn=fl.direction==='inflow';
    const dirCls=isIn?'ff-buy':'ff-sell';
    const amt=Math.abs(fl.daily_flow_dollars/1e6);
    const avg5=Math.abs(fl.avg_flow_5d/1e6);
    // Streak dots: up to 5 dots, colored by direction
    const abStrk=Math.min(Math.abs(fl.streak),5);
    const dotCol=fl.streak>0?'bo-dot-g':'bo-dot-r';
    const dots=Array.from({length:5},(_,i)=>`<div class="bo-dot ${i<abStrk?dotCol:'bo-dot-e'}"></div>`).join('');

    h+=`<div class="sec"><div class="sec-title"><span class="dot" style="background:var(--blue)"></span>ETF Fund Flows</div>`;
    h+=`<div class="ff-box"><div class="ff-hdr">Daily Flow</div>`;
    h+=`<div class="ff-row"><span class="ffl">IBIT</span><span class="ff-dir ${dirCls}">${isIn?'+':'-'}$${amt.toFixed(0)}M ${fl.direction.toUpperCase()}</span></div>`;
    if(fl.total_btc_etf_flow!=null){const tf=fl.total_btc_etf_flow/1e6;const tfIn=tf>=0;h+=`<div class="ff-row"><span class="ffl">All BTC ETFs</span><span class="ff-dir ${tfIn?'ff-buy':'ff-sell'}">${tfIn?'+':''}$${Math.abs(tf).toFixed(0)}M</span></div>`;}
    h+=`<div class="ff-row"><span class="ffl">Impact</span><span class="ffv">${fl.strength}</span></div>`;
    h+=`</div>`;
    h+=`<div class="ff-box"><div class="ff-hdr">5-Day Momentum</div>`;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0"><div class="bo-dots" style="display:flex;gap:2px">${dots}</div><span style="font-size:10px;font-weight:500">${fl.avg_flow_5d>=0?'+':'-'}$${avg5.toFixed(0)}M/d avg</span></div>`;
    h+=`</div></div>`;
  }

  // Dealer Stats
  h+=`<div class="sec"><div class="sec-title"><span class="dot" style="background:var(--t3)"></span>Dealer Position${srcLabel}</div>`;
  [['Net GEX',fG(useLv.net_gex_total)],['Active GEX',fG(useLv.active_gex_total||0)],['Dealer \u0394',fG(useLv.net_dealer_delta||0)],['Net Vanna',fG(useLv.net_vanna||0)],['Net Charm',fG(useLv.net_charm||0)+'/day'],['P/C',(useLv.pcr||0).toFixed(2)],['Call OI',fO(useLv.total_call_oi||0)],['Put OI',fO(useLv.total_put_oi||0)]].forEach(([l,v])=>{
    h+=`<div class="ds-row"><span class="dl">${l}</span><span class="dv">${v}</span></div>`;
  });
  h+=`</div>`;

  // History
  if(data.history&&data.history.length>1){
    h+=`<div class="sec"><div class="sec-title"><span class="dot" style="background:var(--t3)"></span>History</div>`;
    data.history.forEach(r=>{
      const icon=r.regime==='positive_gamma'?'<span style="color:var(--green)">\u25b2</span>':'<span style="color:var(--red)">\u25bc</span>';
      h+=`<div class="hist-row"><span class="hist-date">${r.date.slice(5)}</span><span>${r.btc_price?fB(r.btc_price):'\u2014'}</span><span>${icon}</span><span class="hist-gex">${r.net_gex?fG(r.net_gex):'\u2014'}</span></div>`;
    });
    h+=`</div>`;
  }

  document.getElementById('sidebar').innerHTML=h;
}

async function loadData(){
  const seq=++_loadSeq;
  document.getElementById('loading').classList.remove('hidden');
  try{
    const dteVal=document.getElementById('dte-select').value;
    const [minDte,maxDte]=dteVal.split('-').map(Number);
    const resp=await fetch(`/api/data?ticker=${currentTicker}&dte=${maxDte}&min_dte=${minDte}`);
    if(seq!==_loadSeq)return;
    const data=await resp.json();
    if(seq!==_loadSeq)return;
    if(data.error)throw new Error(data.error);
    window._lastData=data;

    // Header
    if(data.fallback_from){document.getElementById('dte-select').value='0-3';console.warn(`DTE ${data.fallback_from}d unavailable, fell back to 0-3d`)}
    document.getElementById('hdr-btc').textContent=data.btc_spot?fB(data.btc_spot):fmt(data.spot);
    const tkLabel=data.ticker||currentTicker;
    document.getElementById('hdr-ibit').textContent=`${tkLabel} ${fmt(data.spot)}`;
    document.getElementById('hdr-time').textContent=data.timestamp;
    // Data freshness badge
    const freshEl=document.getElementById('hdr-freshness');
    if(data.data_freshness&&data.data_freshness.ibit){
      const ih=data.data_freshness.ibit.age_hours;
      if(!data.data_freshness.ibit.in_market_hours&&ih>16){
        freshEl.style.display='inline';
        freshEl.style.color=ih>40?'#ff4060':'var(--t3)';
        freshEl.textContent=`IBIT ${Math.round(ih)}h old`;
      } else {
        freshEl.style.display='none';
      }
    } else {freshEl.style.display='none'}
    const re=document.getElementById('hdr-regime');
    const neg=data.levels.regime==='negative_gamma';
    re.className=`hdr-regime ${neg?'regime-neg':'regime-pos'}`;
    re.textContent=neg?'\u25bc NEG GAMMA':'\u25b2 POS GAMMA';
    // Positioning confidence badge
    const conf=data.levels.positioning_confidence;
    const confEl=document.getElementById('hdr-conf');
    if(conf!=null){
      const cc=conf>75?'conf-hi':conf>40?'conf-mid':'conf-lo';
      const warnings=data.levels.positioning_warnings||[];
      let tip=`<strong>Positioning Confidence: ${conf}%</strong>`;
      tip+=`How much to trust GEX behavioral labels (walls as resistance/support).`;
      if(warnings.length){tip+=warnings.map(w=>`<div class="cw">\u26a0 ${esc(w)}</div>`).join('')}
      else{tip+=`<div class="cw" style="color:var(--green)">No concerns — standard assumption likely holds</div>`}
      confEl.className=`hdr-conf ${cc}`;
      confEl.innerHTML=`${conf}%<div class="conf-tip">${tip}</div>`;
      confEl.style.display='';
    }else{confEl.style.display='none'}
    const flowEl=document.getElementById('hdr-flow');
    if(data.etf_flows){
      const fl=data.etf_flows;
      const fc=fl.direction==='inflow'?'flow-in':'flow-out';
      const arrow=fl.direction==='inflow'?'\u25b2':'\u25bc';
      const amt=Math.abs(fl.daily_flow_dollars/1e6).toFixed(0);
      flowEl.className=`hdr-flow ${fc}`;
      flowEl.textContent=`${arrow} $${amt}M ${fl.streak>0?`(${fl.streak}d)`:fl.streak<0?`(${Math.abs(fl.streak)}d)`:''}`;
      flowEl.style.display='';
    }else{flowEl.style.display='none'}
    // Deribit source toggle visibility
    const srcSelect=document.getElementById('src-select');
    const srcLabel=document.getElementById('src-label');
    const deribitBadge=document.getElementById('hdr-deribit');
    if(data.deribit_available){
      if(srcLabel)srcLabel.style.display='';
      srcSelect.style.display='';
      deribitBadge.textContent=`${Math.round(data.deribit_oi_btc||0).toLocaleString()} BTC`;
      deribitBadge.style.display='';
    }else{
      if(srcLabel)srcLabel.style.display='none';
      srcSelect.style.display='none';
      deribitBadge.style.display='none';
      currentSource='all';
    }
    const exps=data.expirations||[];
    if(exps.length)document.getElementById('hdr-exp').textContent=`Exp: ${exps[exps.length-1]} 4:00PM ET`;
    else document.getElementById('hdr-exp').textContent='';

    // Chart overlay
    try{
      if(tvSeries){
        const candles=await loadBTC();
        if(seq!==_loadSeq)return;
        if(candles.length) updateChartOverlay(data);
      }
    }catch(e){console.warn('Chart overlay:',e)}

    try{renderGEX(data)}catch(e){console.warn('GEX:',e)}
    if(gexView==='oi'){try{renderOI(data)}catch(e){console.warn('OI:',e)}}
    try{
      const fr=await fetch(`/api/flows?ticker=${currentTicker}`);
      const flows=await fr.json();
      if(seq===_loadSeq&&Array.isArray(flows))renderFlowChart(flows);
    }catch(e){console.warn('Flows:',e)}
    try{renderDealerDelta(data)}catch(e){console.warn('DealerDelta:',e)}
    try{renderSidebar(data)}catch(e){console.warn('Sidebar:',e)}
    try{renderAiPanel()}catch(e){console.warn('AI:',e)}
    loadOutlook();
    loadStructure();

  }catch(e){
    console.error(e);
    document.getElementById('sidebar').innerHTML=`<div class="sec" style="color:var(--red)">Error: ${esc(e.message)}<br><br><button class="hdr-btn" onclick="loadData()">RETRY</button></div>`;
  }
  document.getElementById('loading').classList.add('hidden');
}

function renderAiPanel(){
  const panel=document.getElementById('ai-panel');
  if(!panel)return;
  const aiDte=document.getElementById('dte-select').value+'d';
  let h=`<div class="ai-hdr"><div class="sec-title" style="margin-bottom:0"><span class="dot" style="background:var(--blue)"></span>AI Analysis${aiUnsaved?'<span class="ai-unsaved">UNSAVED</span>':''}</div>`;
  h+=`<div style="display:flex;gap:4px">`;
  if(aiUnsaved)h+=`<button class="ai-btn ai-btn-save" id="ai-save-btn" onclick="saveAnalysis()" title="Save analysis for today">SAVE</button>`;
  h+=`<button class="ai-btn" id="ai-analyze-btn" onclick="runAnalysis()" title="Re-run analysis">&#x21bb;</button>`;
  h+=`</div></div>`;
  if(aiData&&aiData._timestamp){
    h+=`<div style="font-size:9px;color:var(--t3);margin-bottom:4px">Updated ${esc(aiData._timestamp)}${aiData._btc_price?' · BTC '+fB(aiData._btc_price):''}</div>`;
  }
  if(aiData){
    const dteTxt=aiData[aiDte];
    const allTxt=aiData['all'];
    if(dteTxt){h+=`<div class="ai-content">${formatAiText(dteTxt)}</div>`}
    if(allTxt){h+=`<div class="ai-content" style="margin-top:6px;border-left:2px solid var(--blue)"><div style="font-size:9px;font-weight:600;color:var(--blue);margin-bottom:4px;letter-spacing:.4px">CROSS-TIMEFRAME</div>${formatAiText(allTxt)}</div>`}
  }else{
    h+=`<div class="ai-content"><div class="ai-loading"><div class="spin"></div>Waiting for analysis...</div></div>`;
  }
  panel.innerHTML=h;
}

function formatAiText(text){
  // Escape HTML first to prevent XSS from LLM output, then apply safe formatting
  return esc(text)
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\n/g,'<br>');
}

async function loadAnalysis(){
  // Fetch cached analysis; if pending, poll every 10s
  try{
    const resp=await fetch(`/api/analysis?ticker=${currentTicker}`);
    const data=await resp.json();
    if(data.status==='pending'){
      setTimeout(loadAnalysis,10000);
      return;
    }
    aiData=data;
    renderAiPanel();
  }catch(e){console.warn('Analysis fetch:',e)}
}

async function runAnalysis(){
  const btn=document.getElementById('ai-analyze-btn');
  if(!btn)return;
  btn.disabled=true;
  btn.innerHTML='<div class="spin" style="width:10px;height:10px;display:inline-block;vertical-align:middle;border-width:1.5px"></div>';
  try{
    const resp=await fetch(`/api/analyze?ticker=${currentTicker}`,{method:'POST'});
    const data=await resp.json();
    if(data.error)throw new Error(data.error);
    aiData=data;
    aiUnsaved=true;
    renderAiPanel();
  }catch(e){
    console.error('Analysis error:',e);
    const b2=document.getElementById('ai-analyze-btn');
    if(b2){b2.disabled=false;b2.innerHTML='&#x21bb;'}
  }
}

async function saveAnalysis(){
  if(!aiData)return;
  const btn=document.getElementById('ai-save-btn');
  if(btn){btn.disabled=true;btn.textContent='...';}
  try{
    const resp=await fetch(`/api/analysis/save?ticker=${currentTicker}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(aiData)});
    const data=await resp.json();
    if(data.error)throw new Error(data.error);
    aiUnsaved=false;
    renderAiPanel();
  }catch(e){
    console.error('Save error:',e);
    if(btn){btn.disabled=false;btn.textContent='SAVE';}
  }
}

// Outlook funnel
async function loadOutlook(){
  try{
    const r=await fetch(`/api/outlook?ticker=${currentTicker}`);
    const d=await r.json();
    if(d.error||!d.windows||!d.windows.length){document.getElementById('outlook-chart').style.visibility='hidden';return}
    document.getElementById('outlook-chart').style.visibility='visible';
    renderOutlook(d);
  }catch(e){console.warn('Outlook:',e);document.getElementById('outlook-chart').style.visibility='hidden'}
}

function renderOutlook(data){
  const ctx=document.getElementById('outlook-chart');
  if(!ctx)return;
  const wins=data.windows;
  const spot=data.spot;
  if(!wins.length||!spot)return;

  const labels=wins.map(w=>w.label);

  // Datasets
  const callWall=wins.map(w=>w.call_wall);
  const putWall=wins.map(w=>w.put_wall);
  const gammaFlip=wins.map(w=>w.gamma_flip);
  const maxPain=wins.map(w=>w.max_pain);
  const emUpper=wins.map(w=>w.em_upper);
  const emLower=wins.map(w=>w.em_lower);

  // Regime background colors per window
  const regimeBg=wins.map(w=>w.regime==='negative_gamma'?'rgba(255,64,96,0.06)':'rgba(0,220,130,0.06)');

  // Venue agreement diamonds
  const venueAgree=wins.map(w=>w.venue_agree?w.call_wall:null);

  if(outlookChart){outlookChart.destroy();outlookChart=null}

  // Compute y-axis range: encompass all levels with padding
  const allVals=[spot,...callWall,...putWall,...gammaFlip,...maxPain,...emUpper,...emLower].filter(v=>v!=null&&isFinite(v));
  const yMin=Math.min(...allVals);
  const yMax=Math.max(...allVals);
  const yPad=(yMax-yMin)*0.12||1000;

  outlookChart=new Chart(ctx,{
    type:'line',
    data:{
      labels,
      datasets:[
        // EM cone (upper boundary)
        {label:'EM Upper',data:emUpper,borderColor:'rgba(168,139,250,0.5)',borderWidth:1,borderDash:[4,3],pointRadius:0,fill:false,tension:0,order:5},
        // EM cone (lower boundary)
        {label:'EM Lower',data:emLower,borderColor:'rgba(168,139,250,0.5)',borderWidth:1,borderDash:[4,3],pointRadius:0,fill:'-1',backgroundColor:'rgba(168,139,250,0.04)',tension:0,order:5},
        // Call wall
        {label:'Call Wall',data:callWall,borderColor:'rgba(255,64,96,0.7)',borderWidth:2,pointRadius:3,pointBackgroundColor:'rgba(255,64,96,0.9)',fill:false,tension:0,order:2},
        // Put wall
        {label:'Put Wall',data:putWall,borderColor:'rgba(0,220,130,0.7)',borderWidth:2,pointRadius:3,pointBackgroundColor:'rgba(0,220,130,0.9)',fill:false,tension:0,order:2},
        // Gamma flip
        {label:'\u03b3 Flip',data:gammaFlip,borderColor:'rgba(255,176,32,0.6)',borderWidth:1.5,borderDash:[5,3],pointRadius:2,pointBackgroundColor:'rgba(255,176,32,0.7)',fill:false,tension:0,order:3},
        // Max pain
        {label:'Max Pain',data:maxPain,borderColor:'rgba(136,146,164,0.4)',borderWidth:1,borderDash:[3,4],pointRadius:2,pointBackgroundColor:'rgba(136,146,164,0.5)',fill:false,tension:0,order:4},
        // Spot reference
        {label:'Spot',data:wins.map(()=>spot),borderColor:'rgba(220,224,232,0.3)',borderWidth:1,borderDash:[2,2],pointRadius:0,fill:false,tension:0,order:6},
        // Venue agreement diamonds
        {label:'Venue Agree',data:venueAgree,borderColor:'rgba(0,220,130,0.9)',backgroundColor:'rgba(0,220,130,0.9)',pointRadius:wins.map(w=>w.venue_agree?5:0),pointStyle:'rectRot',pointBorderWidth:0,showLine:false,fill:false,order:1},
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:{duration:300},
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:'rgba(6,8,12,0.95)',
          borderColor:'rgba(28,34,48,0.8)',
          borderWidth:1,
          titleFont:{family:'IBM Plex Mono',size:10},
          bodyFont:{family:'IBM Plex Mono',size:10},
          padding:8,
          callbacks:{
            title(items){return items[0]?.label||''},
            label(item){
              const w=wins[item.dataIndex];
              if(!w)return '';
              const ds=item.dataset.label;
              if(ds==='EM Upper')return `EM Upper: ${fB(item.raw)}`;
              if(ds==='EM Lower')return `EM Lower: ${fB(item.raw)}`;
              if(ds==='Call Wall')return `Call Wall: ${fB(item.raw)} (${w.regime==='negative_gamma'?'NEG \u03b3':'POS \u03b3'})`;
              if(ds==='Put Wall')return `Put Wall: ${fB(item.raw)}`;
              if(ds==='\u03b3 Flip')return `\u03b3 Flip: ${fB(item.raw)}`;
              if(ds==='Max Pain')return `Max Pain: ${fB(item.raw)}`;
              if(ds==='Spot')return `Spot: ${fB(item.raw)}`;
              if(ds==='Venue Agree'&&item.raw!=null)return '\u25c6 IBIT+Deribit walls agree';
              return '';
            },
            afterBody(items){
              const w=wins[items[0]?.dataIndex];
              if(!w)return '';
              const lines=[];
              if(w.dealer_delta_dir)lines.push(`Dealers ${w.dealer_delta_dir}`);
              if(w.charm_dir)lines.push(`Charm: ${w.charm_dir}`);
              return lines.join('\n');
            }
          }
        }
      },
      scales:{
        x:{
          grid:{color:'rgba(28,34,48,0.5)',lineWidth:0.5},
          ticks:{font:{family:'IBM Plex Mono',size:9},color:'#4a5568'}
        },
        y:{
          min:Math.floor((yMin-yPad)/1000)*1000,
          max:Math.ceil((yMax+yPad)/1000)*1000,
          grid:{color:'rgba(28,34,48,0.5)',lineWidth:0.5},
          ticks:{font:{family:'IBM Plex Mono',size:9},color:'#4a5568',callback:v=>fB(v)},
          position:'right'
        }
      }
    },
    plugins:[{
      id:'regimeBand',
      beforeDatasetsDraw(chart){
        const{ctx:c,chartArea:{left,right,top,bottom},scales:{x}}=chart;
        const wins2=data.windows;
        wins2.forEach((w,i)=>{
          const xc=x.getPixelForValue(i);
          const half=(right-left)/wins2.length/2;
          c.fillStyle=w.regime==='negative_gamma'?'rgba(255,64,96,0.04)':'rgba(0,220,130,0.04)';
          c.fillRect(xc-half,top,half*2,bottom-top);
        });
      }
    }]
  });
}

// Structure chart (simplified 30d wall evolution) — matches /structure page style
const STRUCT_WINDOWS=[
  {key:'31-45',label:'31-45d',bg:'rgba(168,139,250,0.06)',border:'rgba(168,139,250,0.25)',bw:1},
  {key:'15-30',label:'15-30d',bg:'rgba(255,176,32,0.06)', border:'rgba(255,176,32,0.25)', bw:1},
  {key:'8-14', label:'8-14d', bg:'rgba(56,144,255,0.08)', border:'rgba(56,144,255,0.35)', bw:1.5},
  {key:'4-7',  label:'4-7d',  bg:'rgba(0,180,220,0.10)',  border:'rgba(0,180,220,0.45)',  bw:1.5},
  {key:'0-3',  label:'0-3d',  bg:'rgba(0,220,130,0.12)',  border:'rgba(0,220,130,0.55)',  bw:2},
];

async function loadStructure(){
  try{
    const r=await fetch(`/api/structure?ticker=${currentTicker}&days=30`);
    const d=await r.json();
    renderStructure(d);
  }catch(e){console.warn('Structure:',e)}
}

function renderStructure(data){
  const dates=Object.keys(data).sort();
  if(!dates.length)return;
  const labels=dates.map(d=>d.slice(5));
  const datasets=[];

  // Bands: widest first (31-45d) to narrowest (0-3d) — fill between CW and PW
  for(const w of STRUCT_WINDOWS){
    datasets.push({
      label:w.label+' CW',
      data:dates.map(d=>data[d]?.windows?.[w.key]?.call_wall||null),
      borderColor:w.border,borderWidth:w.bw,pointRadius:0,
      fill:false,spanGaps:true,tension:0,
    });
    datasets.push({
      label:w.label+' PW',
      data:dates.map(d=>data[d]?.windows?.[w.key]?.put_wall||null),
      borderColor:w.border,borderWidth:w.bw,pointRadius:0,
      fill:'-1',backgroundColor:w.bg,spanGaps:true,tension:0,
    });
  }

  // Gamma flip (0-3d) — dashed amber
  datasets.push({
    label:'γ Flip',
    data:dates.map(d=>data[d]?.windows?.['0-3']?.gamma_flip||null),
    borderColor:'rgba(255,176,32,0.6)',borderWidth:1.5,borderDash:[4,3],
    pointRadius:0,fill:false,spanGaps:true,tension:0,
  });

  // Spot — solid white
  datasets.push({
    label:'Spot',
    data:dates.map(d=>data[d]?.spot||null),
    borderColor:'rgba(220,224,232,0.9)',borderWidth:2.5,
    pointRadius:2,pointBackgroundColor:'rgba(220,224,232,0.9)',
    fill:false,spanGaps:true,tension:0,
  });

  // Venue agreement markers on 0-3d call wall and put wall
  const hasAgree=dates.some(d=>data[d]?.windows?.['0-3']?.venue_agree);
  if(hasAgree){
    datasets.push({
      label:'Venue agree',
      data:dates.map(d=>{const w=data[d]?.windows?.['0-3'];return(w&&w.venue_agree)?w.call_wall:null}),
      borderColor:'transparent',backgroundColor:'rgba(0,220,130,0.9)',
      pointRadius:4,pointStyle:'rectRot',pointBorderColor:'rgba(0,220,130,1)',pointBorderWidth:1,
      showLine:false,fill:false,spanGaps:false,
    });
    datasets.push({
      label:'Venue agree',
      data:dates.map(d=>{const w=data[d]?.windows?.['0-3'];return(w&&w.venue_agree)?w.put_wall:null}),
      borderColor:'transparent',backgroundColor:'rgba(0,220,130,0.9)',
      pointRadius:4,pointStyle:'rectRot',pointBorderColor:'rgba(0,220,130,1)',pointBorderWidth:1,
      showLine:false,fill:false,spanGaps:false,
    });
  }

  const ctx=document.getElementById('structure-chart');
  if(structureChart){structureChart.destroy()}
  structureChart=new Chart(ctx,{
    type:'line',
    data:{labels,datasets},
    options:{
      responsive:true,maintainAspectRatio:false,animation:false,
      interaction:{mode:'index',intersect:false},
      scales:{
        x:{grid:{color:'rgba(28,34,48,0.5)'},ticks:{color:'#4a5568',font:{size:8},maxRotation:0,autoSkip:true,maxTicksLimit:7}},
        y:{grace:'5%',grid:{color:'rgba(28,34,48,0.5)'},ticks:{color:'#4a5568',font:{size:9},callback:v=>'$'+(v/1000).toFixed(0)+'K'}}
      },
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:'rgba(11,14,20,0.95)',borderColor:'rgba(28,34,48,1)',borderWidth:1,
          titleFont:{size:10},bodyFont:{size:9},padding:8,
          filter:()=>false,
          callbacks:{
            afterBody:function(items){
              const date=dates[items[0]?.dataIndex];
              if(!date||!data[date])return'';
              const d=data[date];const lines=[];
              const fB=v=>'$'+Math.round(v).toLocaleString();
              lines.push('Spot: '+fB(d.spot));
              for(const w of STRUCT_WINDOWS){
                const win=d.windows?.[w.key];if(!win)continue;
                let l=w.key.padEnd(6)+fB(win.put_wall)+' — '+fB(win.call_wall);
                l+=win.regime==='negative_gamma'?' (neg γ)':' (pos γ)';
                if(win.venue_agree)l+=' ✓';
                lines.push(l);
              }
              const gf=d.windows?.['0-3']?.gamma_flip;
              if(gf)lines.push('γ flip: '+fB(gf));
              return lines.join('\n');
            },
            label:()=>null,
          }
        }
      }
    }
  });
}

// Init
try{initTV()}catch(e){console.warn('TV init:',e)}
loadData();
loadAnalysis();
// Auto-refresh GEX data every 30 min to match backend check interval
setInterval(()=>{loadData();loadAnalysis()},30*60*1000);
</script>
</body>
</html>